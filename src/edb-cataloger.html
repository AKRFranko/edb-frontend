<script>
  EdbCataloger = (superClass) => class extends superClass {
      constructor() {
          super();
          this.__delayTasks = {};
          this.__failedTasks = {};
          
        }
    
        static get properties() {
          return {
            
            baseModules: {
              type: Object,
              value: function(){
                return {};
              }
            },
            compositeModules: {
              type: Object,
              value: function(){
                return {};
              }
            },
            bucketModules: {
              type: Object,
              value: function(){
                return {};
              }
            },
            attributeMap: {
              type: Object,
              value: function(){
                return {};
              }
            },
            productIds: {
              type: Array,
              notify: true,
              value: function(){
                return [];
              }
            },
            categories: {
              type: Object,
              notify: true,
              value: function(){
                return {};
              }
            },
            selectedCategory: {
              type: String,
              value: null,
              observer:'_onSelectedCategoryChanged'
            },
            selectedProduct: {
              type: String,
              value: null,
              observer:'_onSelectedProductChanged'
            },
            catalog: {
              type: Object,
              value: function(){
                return {};
              }
            }
          };
        }
         
        
    
      //   _barChanged(bar) { ... }
    
      //   handlePress(e) { console.log('key pressed: ' + e.charCode); }
      // }
      
      __commonModuleProxy( data ){
        return {
          id: data.id,
          name: data.name,
          description: data.description,
          get image(){
            // console.log('get image', data)
            return data.images[0];
          } , 
          get images(){
            var images = data.images;
            images.push(images.shift());
            return images;
          } 
        }
      }
      _createCompositeModuleProxy( id ){
        var productData = this.compositeModules[id];
        return Object.assign(
          this.__commonModuleProxy( productData ),
          {
            get minPrice(){
              return 0;//parseFloat(productData.metaData.edb_base_price) + parseFloat(productData.metaData._min_variation_price)
            },
            
            get maxPrice(){
              return 0;//parseFloat(productData.metaData.edb_base_price) + parseFloat(productData.metaData._max_variation_price)
            }
          }
        );
     
      }
      _createBaseModuleProxy( id ){
        var productData = this.baseModules[id];
        
        return Object.assign(
          this.__commonModuleProxy( productData ),{
            get minPrice(){
              return parseFloat(productData.metaData.edb_base_price) + parseFloat(productData.metaData._min_variation_price)
            },
            
            get maxPrice(){
              return parseFloat(productData.metaData.edb_base_price) + parseFloat(productData.metaData._max_variation_price)
            }
          }
          
        );
        
      }
      
      _createProduct(id){
        var isBaseModule = !!this.baseModules[id];
        var isCompositeModule = !!this.compositeModules[id];
        if(isBaseModule){
          this.set('currentProduct', this._createBaseModuleProxy( id )  );
        }else if(isCompositeModule){
          this.set('currentProduct', this._createCompositeModuleProxy( id )  );
        }
        console.log(this.currentProduct)
        this._updateSubscribers('currentProduct');
        console.log('createProduct', id );
      }
      
      _createCatalog(category){
        var catalog = [];
        category.itemIds.forEach( ( id )=>{
          var isBaseModule = !!this.baseModules[id];
          var isCompositeModule = !!this.compositeModules[id];
          if(isBaseModule){
            catalog.push( this._createBaseModuleProxy( id ) );
          }else if(isCompositeModule){
            catalog.push( this._createCompositeModuleProxy( id ) );
          }
        });
        this.set('catalog', catalog );
        this._updateSubscribers('catalog');
        // console.log('_createCatalog',category)
      }
      
      _loadSelectedCategory( category ){
        if(!category) return Promise.reject(new TypeError('No category provided'));
        if(this.categories[category]){
          this._createCatalog( this.categories[category] );
          return Promise.resolve();
        }
        return new Promise( ( resolve, reject )=>{
          var startTime = Date.now();
          var listenUntilFound = (event)=>{
            if(this.categories[category]){
              this.removeEventListener('categories-changed', listenUntilFound );
              this._createCatalog( this.categories[category] );
              return resolve();
            }else{
              if(Date.now() - startTime > 10000){
                this.removeEventListener('categories-changed', listenUntilFound );
                return reject('Timeout');
              }
            }
          }
          this.addEventListener('categories-changed', listenUntilFound );  
        });
      }
      
      _onSelectedCategoryChanged( category ){
        if(!category) return;
        return this._loadSelectedCategory(category);
        
      }
      
      
      _importModuleVariations( imports ){
        console.log('_importModuleVariations', imports );
        var initial = Promise.resolve();
        return imports.reduce( ( previous, next  )=>{
          return previous.then( ()=>{
            console.log('next',next)
            return this._fetchVariations( next.id, next.ids );
          } )
        }, initial )
      }
      
      _fetchVariations( id, vids){
        return new Promise( (resolve, reject)=>{
          this.loading=true;
          var xhr = document.createElement('iron-request');
          // var mirror = document.createElement('app-indexeddb-mirror');
          // var onDataChanged = (  )=>{
            // console.log('onDataChanged')
            // if(mirror.persistedData){
              // resolve( id );
              // mirror.removeEventListener( onDataChanged );
              // this.loading=false;
              // console.log('_fetchVariations', 'fetched!');
            // }
          // }
          // mirror.addEventListener('persisted-data-changed', onDataChanged );
          var fetch = xhr.send({
            url: this.$.products.url + '/' + id + '/variations',
            handleAs: 'json',
            headers: this.headers
          });
          
          fetch.then( ( variations )=>{
            // console.log('fetch.then',variations.response)
            // mirror.set('data', variations.response);
            console.log('_fetchVariations', 'fetched!');
            this.loading=false;
            resolve( id  );
          },reject );
          // mirror.key = ['product',id,'variations'].join(':');
        });  
      }
      
      
      __wait( event, check ){
        console.log('wait', event );
        return new Promise( ( resolve, reject )=>{
          var start = Date.now();
          var fn = (e)=>{
            
            if(check.call(this)){
              console.log(event, 'passed!')
              this.removeEventListener( event, fn );
              resolve();
            }
            if(Date.now() - start > 10000){
              console.log(event, 'timeout!')
              this.removeEventListener( event, fn );
              reject( new Error('Timeout') );
            }
          }
          this.addEventListener(event, fn );
        });
      }
      
      _loadSelectedProduct(id){
        console.log('_loadSelectedProduct', id )
        var waitForProduct;
        if(!id) return Promise.reject(new TypeError('No id provided'));
        if(~this.productIds.indexOf(id)){
          waitForProduct = Promise.resolve();
        }else{
          waitForProduct = this.__wait('product-ids-changed', ()=>{
            return ~this.productIds.indexOf(id);
          });  
        }
        
        var waitForVariations =  waitForProduct.then( ()=>{
          console.log('product loaded, loading variations...')
          var isCompositeModule = !!this.compositeModules[id];
          var product = isCompositeModule ? this.compositeModules[id] : this.baseModules[id];
          var imports;
          if(isCompositeModule){
            var groupids = product.metaData.edb_group_ids.split(',');
            imports = groupids.reduce( (vids,gid)=>{
              vids.push({ id: gid, ids: this.baseModules[gid].variations });
              return vids;
            }, [] );
          }else{
            imports = [ { id: id, ids: product.variations } ] ;
          }
          
          return this._importModuleVariations( imports ).then( this._createProduct.bind(this) );
        });
        return waitForVariations;
        
        
      }
      
      _onSelectedProductChanged( id ){
        if(!id) return;
        if(!this.baseModules[id] || !this.compositeModules[id]){
          return;
        }
        return this._loadSelectedProduct(id);
        // var isCompositeModule = !!this.compositeModules[id];
        // var imports ;
        // if(isCompositeModule){
        //   var groupids = product.metaData.edb_group_ids.split(',');
        //   imports = groupids.reduce( (vids,gid)=>{
        //     vids.push({ id: gid, ids: this.baseModules[gid].variations });
        //     return vids;
        //   }, [] );
        // }else{
        //   imports = [ { id: id, ids: this.baseModules[id].variations()} ] ;
        // }
        
        // this._importModuleVariations( imports ).then( this._createProduct.bind(this) );

      }
      
      prepareForRoute( shopBase, category, id ){
        if(this.preparingForRoute) return Promise.reject('Debounce me?');
        this.preparingForRoute = true;
        var output = null;
        if( shopBase != 'shop' ){
          output = Promise.reject('Not shop?');
        }else{
          if( category && !id){
            if(this.categories[category]){
              output = Promise.resolve();
            }else{
              output = this._loadSelectedCategory(category);
            }
          }else if( category && id ){
            output = this._loadSelectedProduct( id );
          }else{
            output = Promise.resolve();
          }
            
        }
        return output.then( ()=>{
          this.preparingForRoute = false;
        },()=>{
            this.preparingForRoute = false;
          });
        
      }
      
      _importBucketModule( product ){
        this.bucketModules[product.metaData.edb_bucket_slug] = product;
        this.notifyPath('bucketModules.'+product.id);
      }
      
      _importCompositeModule( product ){
        var groupids = product.metaData.edb_group_ids.split(',');
        var basesLoaded = groupids.every( (id)=>{
          return !!this.baseModules[id];
        });
        if(!basesLoaded){
          if(!this.__failedTasks[product.id]){
            this.__failedTasks[product.id] = 0;
          }
          if(this.__delayTasks[product.id] && this.__delayTasks[product.id].cancel ){
            this.__delayTasks[product.id].cancel();
            this.__failedTasks[product.id]++;
          }
          if(this.__failedTasks[product.id] > (this.products.length||0)+2 ){
            return console.log('ignoring composite, failed too many times', product);
          }
          return this.__delayTasks[product.id] = Polymer.Async.idlePeriod.run( ()=>{
            this._importCompositeModule( product );
          });
        }
        this.compositeModules[product.id] = product;  
        this.notifyPath('compositeModules.'+product.id);
      }
      
      _importBaseModule( product ){
        this.baseModules[product.id] = product;
        this.notifyPath('baseModules.'+product.id);
      }
      _importProductAttributes( product ){
        product.attributes.forEach( ( attribute )=>{
          if(!this.attributeMap[product.id]){
            this.attributeMap[product.id] = {};
          }
          if(!this.attributeMap[product.id][attribute.name]){
            this.attributeMap[product.id][attribute.name] = {
              get name(){
                return attribute.name;
              },
              get options(){
                return attribute.options;
              }
            }
          }
          if(this.bucketModules[attribute.name]){
            Object.defineProperty(this.attributeMap[product.id][attribute.name], 'quantity',  { 
              get: function(){
                return 
              } 
            });
          }
          // if(!this.attributeMap[product.id][attribute.name].options){
          //   this.attributeMap[product.id][attribute.name].options = {};
          // }
          
        })
      }
      
      _importProductCategories( product ){
        product.categories.forEach( ( category )=>{
          if(!this.categories[category.slug]){
            this.categories[category.slug] = category;
          }  
          if(!this.categories[category.slug].itemIds){
            this.categories[category.slug].itemIds = [];
          }
          if(!this.categories[category.slug].itemCount){
            this.categories[category.slug].itemCount = 0;
          }
          this.categories[category.slug].itemIds.push( '' + product.id );
          this.categories[category.slug].itemCount++;
          this.notifyPath('categories.'+category.slug);
          
        });  
      }
      
      _importProduct( product ){
        
        var moduleType=null;
        if(product.metaData.edb_is_bucket === '1'){
          moduleType = 'bucket';
          this._importBucketModule( product );
        }else if(product.metaData.edb_group_ids){
          moduleType = 'composite';
          this._importCompositeModule(product);
        }else{
          moduleType = 'base';
          this._importBaseModule( product );
        }
        if(moduleType !== 'bucket'){
          this.push('productIds', '' + product.id);
          this._importProductCategories(product);
        }
        
      }
      
      
      _onProductsChanged( products ){
        
        if(products){
          Array.prototype.forEach.call(products, (product)=>{
            product.metaData = {};
            for(var k in product.meta_data){
              product.metaData[product.meta_data[k].key] = product.meta_data[k].value;
            }
            
            this._importProduct(product);
          });
          this._updateSubscribers('currentProduct');
          console.log('categories',this.categories) ;
          this._updateSubscribers('categories');
          // var initial = Promise.resolve();
          // products.reduce( ( previous, next )=>{
          //   return previous.then( ()=>{
          //     var xhr = document.createElement('iron-request');
          //     return xhr.send({
          //       url: this.$.products.url + '/' + next.id +'/variations',
          //       handleAs: 'json',
          //       headers: this.headers
          //     }).then( ()=>{
          //       next.variations = xhr.response;
               
          //     });
          //   });
          // },initial).then( ( allsolved )=>{
            
            
          //   
          // })
          
        }
        
        
      }
    }
</script>