<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="edb-api-control">
  <template>
    <style>
      :host{
        display:block;
        width:100%;
        background:#000;
        color:lime;
      }
      #debug{
        width:100%;
        @apply --layout-vertical;
      }
      iron-icon{
        margin:10px;
        width:60px;
        height:60px;
      }
      .debug-line{
        display:block;
        width:100%;
        min-width:100%;
        padding:6px;
        @apply --layout-horizontal;
        @apply --layout-start-justified;
      }
      .flex{
        @apply --layout-flex;
      }
      .debug-line > *{
        padding:0 6px;
      }
    </style>
   
   <iron-localstorage name="edb-jwt-auth" value="{{jwtAuth}}"></iron-localstorage>
   
   
   <iron-ajax debounce-duration="300" loading="{{loading}}" id="jwtAuth"      url="[[apiRoot]]/wp-json/jwt-auth/v1/token" method="post" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{jwtAuth}}"></iron-ajax>
   <edb-api-request last-source="{{currentUserLastSource}}" debounce-duration="300" loading="{{loading}}" id="currentUser"  url="[[apiRoot]]/wp-json/wp/v2/users/me" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{currentUser}}"></edb-api-request>
   <iron-ajax id="newUser"  url="[[apiRoot]]/wp-json/wp/v2/register" method="post" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{newUser}}"></iron-ajax>
   <edb-api-request last-source="{{materialsLastSource}}" auto id="materials" loading="{{loading}}" url="[[apiRoot]]/wp-json/wp/v2/materials" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{materials}}" params="{{commonParams}}"></edb-api-request>
   <edb-api-request last-source="{{featuresLastSource}}" auto id="features" loading="{{loading}}" url="[[apiRoot]]/wp-json/wp/v2/features" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{features}}"></edb-api-request>
   <edb-api-request last-source="{{slidesLastSource}}" auto id="slides" loading="{{loading}}" url="[[apiRoot]]/wp-json/wp/v2/slides" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{slides}}"></edb-api-request>
   
   <edb-api-request auto last-source="{{pagesLastSource}}" id="pages" loading="{{loading}}" url="[[apiRoot]]/wp-json/wp/v2/pages" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{pages}}"></edb-api-request>
   <edb-api-request auto last-source="{{inspirationsLastSource}}" id="inspirations" loading="{{loading}}" url="[[apiRoot]]/wp-json/wp/v2/inspirations" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{inspirations}}"></edb-api-request>
   <edb-api-request auto last-source="{{lookbooksLastSource}}" id="lookbooks" loading="{{loading}}" url="[[apiRoot]]/wp-json/wp/v2/lookbooks" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{lookbooks}}"></edb-api-request>
   <edb-api-request auto last-source="{{productsLastSource}}" id="products" loading="{{loading}}" url="[[apiRoot]]/wp-json/wc/v2/products" method="get" params="[[productsParams]]" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{products}}"></edb-api-request>
   
   <!--<edb-api-request id="productVariations" loading="{{loading}}" url="[[apiRoot]]/wp-json/wc/v2/products/[[currentProduct.id]]/variations" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{currentProductVariations}}"></edb-api-request>-->
   <edb-api-request id="customerOrders" loading="{{loading}}" url="[[apiRoot]]/wp-json/wc/v2/orders" params="[[_computeCustomerIdParam(currentUser)]]" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{currentCustomerOrders}}"></edb-api-request>   
    
   <!--<array-selector id="productSelector"   items="{{products}}" selected="{{ignore}}"></array-selector>-->
   <array-selector id="pageSelector"      items="{{pages}}" selected="{{currentPage}}"></array-selector>
   <!--<array-selector id="variationSelector" items="{{currentProductVariations}}" selected="{{currentVariation}}"></array-selector>-->
   
   
  <!--<edb-api-catalog materials="[[materials]]" products="[[products]]" current-category="[[selectedCategory]]" current-product="[[currentProduct]]"  categories="{{categories}}" items="{{catalogItems}}" current-item="{{currentCatalogItem}}"></edb-api-catalog>-->
  
   <edb-catalog-brain-element id="importer" 
    api-product-data="[[products]]" 
    selected-category="[[selectedCategory]]" 
    selected-product="[[selectedProduct]]" 
    categories="{{categories}}" 
    current-listing="{{catalogItems}}" 
    current-product="{{currentCatalogItem}}"
    cart-item-count="{{cartItemCount}}"></edb-catalog-brain-element>
   <app-location route="{{liveRoute}}" url-space-regex="^[[rootPath]]"></app-location>
  
  <div id="debug">
    <iron-icon icon="my-icons:bug"></iron-icon>
    <div class="debug-line">
      <b>route</b><i>[[_emptyText(route.path)]]</i>
    </div>
    <div class="debug-line">
      <b>jwtAuth</b><i>Token: [[_boolText(jwtAuth.token)]]</i>
    </div>
    <div class="debug-line">
      <b>cart</b><i>Count: [[cartItemCount]]</i>
    </div>
    <div class="debug-line">
      <b>currentUser</b><i>Loaded: [[_boolText(currentUser.name)]]</i>
      <i>Via: [[currentUserLastSource]]</i>
      <i>Name: [[_emptyText(currentUser.name)]]</i>
      <i>Billing: [[_emptyText(currentUser.customer_meta.billing_postcode)]]</i>
      <i>Shipping: [[_emptyText(currentUser.customer_meta.shipping_postcode)]]</i>
      <i>[ Orders: Loaded: [[_boolText(currentCustomerOrders)]] Count: [[currentCustomerOrders.length]] ]</i>
      
    </div>
    <div class="debug-line">
      <b>materials</b><i>Loaded: [[_boolText(materials.length)]]</i>
      
      <i>Via: [[materialsLastSource]]</i>
      <i>Count: [[materials.length]]</i>
    </div>
    <div class="debug-line">
      <b>features</b><i>Loaded: [[_boolText(features.length)]]</i>
      <i>Via: [[featuresLastSource]]</i>
      <i>Count: [[features.length]]</i>
    </div>
    <div class="debug-line">
      <b>slides</b><i>Loaded: [[_boolText(slides.length)]]</i>
      <i>Via: [[slidesLastSource]]</i>
      <i>Count: [[slides.length]]</i>
    </div>
    <div class="debug-line">
      <b>inspirations</b><i>Loaded: [[_boolText(inspirations.length)]]</i>
      <i>Via: [[inspirationsLastSource]]</i>
      <i>Count: [[inspirations.length]]</i>
    </div>
    <div class="debug-line">
      <b>lookbooks</b><i>Loaded: [[_boolText(lookbooks.length)]]</i>
      <i>Via: [[lookbooksLastSource]]</i>
      <i>Count: [[lookbooks.length]]</i>
    </div>
    <div class="debug-line">
      <b>product data</b><i>Loaded: [[_boolText(products.length)]]</i>
      <i>Via: [[productsLastSource]]</i>
      <i>Count: [[products.length]]</i>
    </div>
    <div class="debug-line">
      <b>products</b><i>Loaded: [[_boolText(catalogItems.length)]]</i>
      <i>Count: [[catalogItems.length]]</i>
      <i>Current: [[_emptyText(currentProduct.id)]]</i>
    </div>
    <div class="debug-line">
      <b>categories</b><i>Loaded: [[_boolText(categories.length)]]</i>
      <i>Count: [[categories.length]]</i>
      <i>Current: [[_emptyText(selectedCategory)]]</i>
    </div>
    
  </div>
    
  </template>
  <script>
    (function(){
      
       
       class EdbApiControl extends MyOptionsMixin(Polymer.Element) {
         static get is() { return 'edb-api-control'; }
         static get properties() {
           return {
             liveRoute: {
               type: Object,
               observer: '_liveRouteChanged'
             },
             route: {
               type: Object,
               value: null,
               notify: true
             },
             rootPath: String,
             apiRoot: {
               type: String,
               value: 'https://installatex.ca'
             },
             features: {
               type: Array,
               notify: true,
               resource: true,
               exposed: true,
               cached: true
             },
             slides: {
               type: Array,
               notify: true,
               resource: true,
               exposed: true,
               cached: true
             },
             
             materials: {
               type: Array,
               notify: true,
               resource: true,
               exposed: true,
               cached: true
             },
             inspirations: {
               type: Array,
               notify: true,
               resource: true,
               exposed: true,
               cached: true
             },
             lookbooks: {
               type: Array,
               notify: true,
               resource: true,
               exposed: true,
               cached: true
             },
             pages: {
               type: Array,
               notify: true,
               resource: true,
               exposed: true,
               cached: true
             },
             products: {
               type: Array,
               resource: true,
               
             },
             
             categories: {
               type: Array,
               notify: true
             },
             
             productsParams: {
               type: Object,
               value: function(){
                 return {
                   per_page: 100,
                   embed: 1,
                   status:'publish'
                 }
               }
             },
             commonParams: {
               type: Object,
               value: function(){
                 return {
                   per_page: 100,
                   embed: 1
                   
                 }
               }
             },
            // currentProduct:{
            //   type: Object,
            //   notify: true,
            //   exposed: true
            // },
            // currentProductVariations:{
            //   type: Object,
            //   notify: true,
            //   exposed: true
            // },
             currentVariation:{
               type: Object,
               notify: true,
               exposed: true
             },
             currentPage:{
               type: Object,
               notify: true,
               exposed: true
             },
             about: {
               type: Object,
               notify: true,
               exposed: true
             },
             currentUser: {
               type: Object,
               resource: true,
               notify: true,
               exposed: true
             },
             jwtAuth: {
               type: Object,
               resource: true,
               notify: true,
               exposed: true
             },
             headers: {
               type: Object,
               computed: '_computeHeaders(defaultHeaders,authHeaders)'
             },
             loading: {
               type: Boolean,
               notify: true,
               value: true
             },
             authHeaders: {
               type: Object,
               value: function(){
                 return {};
               }
             },
             defaultHeaders: {
               type: Object,
               value: function(){
                 return {
                   "X-Requested-With": "XMLHttpRequest",
                   "cache-control": "max-stale"
                 };
               }
             },
             subscribers: {
               type: Array,
               value: function(){ return []; }
             },
             sessionToken: {
               type: String,
               notify: true,
               computed: '_computeSessionToken(jwtAuth)'
             },
             selectedProduct:{
               notify: true,
               type: Number
             }
             ,selectedCategory: {
               notify: true,
               type: String,
               value: null
             },
             
             selectedVariation: {
               notify: true,
               type: Number,
               value: null
             },
             catalogItems: {
               type: Array,
               notify: true,
             },
             currentCatalogItem: {
               type: Object,
               notify: true,
             },
             cartItems: {
               type: Array,
               notify: true
             },
             cartItemCount: {
               type: Number,
               notify: true
             }
           };
         }
         _boolText( t ){
           return (!t) ? 'false' : 'true';
         }
         _emptyText( t ){
           return !t ? '...' : t;
         }
         
        static get observers(){
          return [
            '_onJwtAuthChanged(jwtAuth)',
            // '_onCurrentProductChanged(currentProduct)',
            '_onCurrentUserChanged(currentUser)',
            '_onProductsChanged(products)',
            '_onSelectedProductChanged(selectedProduct)',
            // '_onSelectedVariationChanged(selectedVariation,currentProductVariations)',
            // '_notifyChange("ccitem",currentCatalogItem)',
            
            // '_notifyChange("slides",slides)',
            '_onMaterials(materials)'
            ];
        }
        
        _onMaterials(mats){
          
          if(mats){
            if(!this.options.materials){
              var materials = {};
              mats.forEach( (  m )=>{
                materials[m.meta_box.edb_material_number] = m;
              });
              this.options.materials = materials;
            }
          }
          
        }
        
        _notifyChange(path,data){
          // console.log('_notifyChange',path, data)
          this.notifyPath(path, data);
        }
        
        
        _onSelectedProductChanged(id){
          // console.log('_onSelectedProductChanged',id)
          // if(id && products && products.length > 0){
          //   var index = this.$.productSelector.items.findIndex( function( item  ){ return parseFloat(item.id) == parseFloat(id);});
          //   if(index || index ===0){
          //     // console.log('selecting product at index' + index + ' for id ' + id)
          //     this.$.productSelector.selectIndex( index );
          //   }
          // }
        }
        _onSelectedVariationChanged(id,variations){
          if(id && variations && variations.length > 0){
            var index = this.$.variationSelector.items.findIndex( function( item  ){ return parseFloat(item.id) == parseFloat(id);});
            if(index || index ===0){
              // console.log('selecting variation at index' + index + ' for product ' + id)
              this.$.variationSelector.selectIndex( index );
            }
          }
        }
        
        _liveRouteChanged(route){
          if(!this.$.importer.imported){
            return this.$.importer.addEventListener('imported-changed', (e)=>{
              console.log('imported')
              
              return this._liveRouteChanged( route );
            }, { once: true })
            
          }
          if(/shop/.test( route.path )){
            
            var paths = route.path.split('/').filter( function(a){ return !!a});
            if(paths[1]){
              this.set('selectedCategory', paths[1] );
            }else{
              this.set('selectedCategory', null );
            }
            if(paths[2] || paths[2] === 0){
              this.set('selectedProduct', parseInt(paths[2]) );
            }else{
              this.set('selectedProduct', null );
            }
            if(paths[3] || paths[3] === 0){
              this.set('selectedVariation', paths[3] );
            }else{
              this.set('selectedVariation', null );
            }
          }
          this.set('route', route);  

        }
        
        _computeCustomerIdParam(currentUser){
          if(!currentUser || (currentUser && !currentUser.id)) return null;
          return {customer_id:currentUser.id};
        }
        
        _onProductsChanged(products){
          
          // if(products && products.length){
          //   this.$.productSelector.selectIndex(0);
          // }
        }
        
        _onCurrentUserChanged(currentUser){
          if(currentUser && currentUser.id){
            if(this.jwtAuth && this.jwtAuth.user_email && !currentUser.email){
              this.currentUser.email = this.jwtAuth.user_email
              return this._onCurrentUserChanged( currentUser );
            }
            this.$.customerOrders.generateRequest();    
          }  
        }
        
        _onCurrentProductChanged(currentProduct){
          if(currentProduct && currentProduct.id){
            // this.$.productVariations.generateRequest();    
          }
        }
        
        

         
        _computeSessionToken(auth){
          var token = auth && auth !== null ? auth.token : 'nobody';
          var d = new Date();
          return [token,d.getFullYear(), d.getMonth(), d.getDate() ].join('-')
        }
        
         
        _onJwtAuthChanged(jwtAuth){
          this.$.jwtAuth.body = {};
          if(!jwtAuth || (jwtAuth && !jwtAuth.token)){
            // console.log('No Token, flushing all data');
            // window.EdbApiRequest.flushall();
            this.authHeaders = {};
          }else{
            // console.log('yes jwtToken')
            this.authHeaders = { 'Authorization': 'Bearer ' + jwtAuth.token };
            Polymer.Async.microTask.run( ()=>{
              this.$.currentUser.generateRequest();
              
            } );
          }
        }
         
         
        _computeHeaders(defaultHeaders,authHeaders){
          return Object.assign({},defaultHeaders,authHeaders);
        }
        
        connectedCallback(){
          super.connectedCallback();
          
          window.EdbApiControl.instance = this;
          
          // var props = Object.keys(Object.getPrototypeOf(this.$.importer).constructor.properties);
          // props.forEach( ( prop )=>{
          //   this.$.importer.addEventListener(`${prop}-changed`, ()=>{
          //     // console.log(`${prop}-changed`)
          //     this.notifyPath(prop)
          //     // this.set(prop,this.$.importer[prop]);
          //   })
          // })
          
          // return this._fetchProductVariations( 463 );
          // this.$.features.generateRequest();
        }
         
         
        updateCurrentUser(){
            var data = this.currentUser;
            var xhr = this.$.currentUser;
            xhr.method = 'put';
            xhr.body = data;
            return xhr.generateRequest().then( function(){
              xhr.method = 'get';
              xhr.body = null;
            });
        }
        
        register(user,password,confirm,data){
          if(!data.username){
            // data.username = user.split('').map(function(s){
            //   return s.charCodeAt(0).toString(24);
            // }).join('');
            data.username = user;
            
          }
          if(data.first_name){
            data.nickname = data.first_name;
          }else{
            data.nickname = user.slice(0, user.indexOf('@'));
          }
          data.locale = 'en_US';
          data.role = 'customer';
          data.email = user;
          data.password = password;
          data.password_confirm = confirm;
          this.$.newUser.body = data;
          var xhr = this.$.newUser.generateRequest();
          return new Promise( (resolve,reject)=>{
            return xhr.completes.then( ()=>{
              console.log('registered! Loging in...')
              return this.login( user, password ).then( resolve );
            },()=>{
                reject( xhr.response );
              });
          });
        }
        
        login(user,password){
          this.$.jwtAuth.body={username:user,password:password};
          var xhr = this.$.jwtAuth.generateRequest();
          return new Promise( ( resolve, reject )=>{
            return xhr.completes.then( resolve , ()=>{
              reject( xhr.response );
            } );
          });
        }
         
        logout(){
          this.set('jwtAuth', null );
          window.location.href = '/';
        }
         
   
         
       }
       
       window.EdbApiControl = EdbApiControl;
       window.customElements.define(EdbApiControl.is, EdbApiControl);
       
       
       
       
     })();
  </script>
</dom-module>