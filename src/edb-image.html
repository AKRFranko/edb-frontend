<link rel="import" href="../bower_components/polymer/polymer-element.html">


<dom-module id="edb-image">
  <template>
    <style>
      :host {
        display: block;
        @apply --layout;
        position:relative;
      }
      iron-image{
        position:absolute;
        top:0;left:0;right:0;bottom:0;
        width:100%;
        height:100%;
      }
    </style>
    <iron-image id="image" sizing="cover" src="{{imageSrc}}"  preload fade style="[[_setBgColor(image.colors)]]"></iron-image>
  </template>

  <script>
    (function() {

      

      class EdbImage extends Polymer.Element {
        static get is() { return 'edb-image'; }

        static get properties() {
          return {
            image: {
              type: Object,
              notify: true,
              value: () => ({
                src: null,
                colors: []
              })
            },
            imageSrc: {
              type: String
            },
            visible: {
              type: Boolean,
              notify: true,
              value: false
            },
            useImageForSize: {
              type: Boolean,
              notify: true,
              value: false
            }
            
            
          }
        }

        static get observers() {
          return [
            'visibilityChanged(image,visible)',
            'imageChanged(image)',
            // 'setupImageSize(useImageForSize,image.src)'
          ]
        }
        // setupImageSize(useImageForSize){
        //   if(useImageForSize){
        //     if(!this.$.image.loaded){
        //       this.$.image.addEventListener('loaded-changed', (e)=>{
        //         if(e.detail.value){
                  
        //           this.setupImageSize(useImageForSize);
        //         }
        //       });
        //     }
        //     var realImage = this.$.image.shadowRoot.querySelector('img');
        //     this.style.width=realImage.naturalWidth;
        //     this.style.height=realImage.naturalHeight;
        //   }
          
        // }
        
        visibilityChanged(image,visible){
          if(!image) return;
          if(!image.src) return;
          if(!visible) return;
          if(!this.imageSrc){
            this.imageSrc = image.src;
            
            
          } 
          
        }
        
        // __onLoadedChanged( e ){
        //     var loaded = e.detail.value;
        //     if(loaded){
        //       this.dispatchEvent(new CustomEvent('image-loaded', {detail:  this }));
        //     }
            
        // }
        
        loadImage(){
          this.visible=true;
        }
        imageChanged(image){
          if(image && image.src){
            this.dispatchEvent(new CustomEvent('bound', {detail:  {image: this.image, element: this } }));
          }
          if(this.visible && image && image.src ){
            this.visibilityChanged(image,true)
          }  
          if( image&&image.width){
            var w = image.width;
            var h = image.height;
            if(w > h){
              this.classList.add('landscape');
              if(w/2 > h){
                this.classList.add('wide-landscape');
              }else if(Math.max(w,h) - Math.min(w,h) < 10){
                this.classList.add('square-landscape');
              }
            }else if(h > w){
              this.classList.add('portrait');
              if(h/2 > w){
                this.classList.add('wide-portrait');
              }else if(Math.max(w,h) - Math.min(w,h) < 10){
                 this.classList.add('square-portrait');
              }
            }else if(h == w){
              this.classList.add('square');
            }
            
            
          }
        }
        
        
        _setBgColor(colors){
          
          if(!Array.isArray(colors)) return null;
          var gradientColors = [];
          if(colors.length == 0){
            colors = ['#cccccc','#ffffff','#999999']
          }
          // sort by darkest saturated color.
          colors.sort( function( a, b){
            var sa = (tinycolor(a).toHsl().s - tinycolor(a).toHsl().l);
            var sb = (tinycolor(b).toHsl().s - tinycolor(b).toHsl().s);
            return  sa >  sb ? -1 : sb > sa ? 1 : 0;
          } );
          // grab first two
          var colorA = tinycolor(colors.shift());
          var colorB = tinycolor(colors.shift());
          // make translucent
          colorA.setAlpha(0.6);
          colorB.setAlpha(0.6);
  
          gradientColors.push(colorA.toString());
          gradientColors.push(colorB.toString());
          
          
          // gradientColors.push(colors.shift());
          // gradientColors.push(colors[0]);
          // gradientColors.push(colors[Math.round(colors.length/2)]);
          // gradientColors.push(colors[colors.length-1]);
          return 'background-image:radial-gradient(at bottom right, ' +gradientColors.join(',')+');';
          
        }

       
      }
      window.customElements.define(EdbImage.is, EdbImage);
      
      
    }());
  </script>
</dom-module>