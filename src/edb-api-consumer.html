<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="edb-api-consumer">
  <template>
    
    <iron-localstorage name="edb-jwt-auth" value="{{jwtAuth}}"></iron-localstorage>
    
    
    <iron-ajax debounce-duration="300" loading="{{loading}}" id="jwtAuth"      url="[[apiRoot]]/wp-json/jwt-auth/v1/token" method="post" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{jwtAuth}}"></iron-ajax>
    
    
    <iron-ajax debounce-duration="300" loading="{{loading}}" id="currentUser"  url="[[apiRoot]]/wp-json/wp/v2/users/me" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{currentUserLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="currentUserDb"
        session="[[sessionToken]]"
        key="currentUser"
        data="[[currentUserLive]]"
        persisted-data="{{currentUser}}"
        >
    </app-indexeddb-mirror>
    
    
    <iron-ajax loading="{{loading}}" id="features"     url="[[apiRoot]]/wp-json/wp/v2/features" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{featuresLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="featuresDb"
        key="features"
        data="{{featuresLive}}"
        persisted-data="{{features}}">
    </app-indexeddb-mirror>
    
    <iron-ajax loading="{{loading}}" id="slides"     url="[[apiRoot]]/wp-json/wp/v2/slides" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{slidesLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="slidesDb"
        key="slides"
        data="{{slidesLive}}"
        persisted-data="{{slides}}">
    </app-indexeddb-mirror>
    
    <iron-ajax loading="{{loading}}" id="inspirations" url="[[apiRoot]]/wp-json/wp/v2/inspirations" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{inspirationsLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="inspirationsDb"
        key="inspirations"
        data="{{inspirationsLive}}"
        persisted-data="{{inspirations}}">
    </app-indexeddb-mirror>
    
    <iron-ajax loading="{{loading}}" id="lookbooks"    url="[[apiRoot]]/wp-json/wp/v2/lookbooks" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{lookbooksLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="lookbooksDb"
        key="lookbooks"
        data="{{lookbooksLive}}"
        persisted-data="{{lookbooks}}">
    </app-indexeddb-mirror>
    
    <iron-ajax loading="{{loading}}" id="materials"    url="[[apiRoot]]/wp-json/wp/v2/materials" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{materialsLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="materialsDb"
        key="materials"
        data="{{materialsLive}}"
        persisted-data="{{materials}}">
    </app-indexeddb-mirror>
    
    <iron-ajax loading="{{loading}}" id="pages"        url="[[apiRoot]]/wp-json/wp/v2/pages" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{pagesLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="pagesDb"
        key="pages"
        data="{{pagesLive}}"
        persisted-data="{{pages}}">
    </app-indexeddb-mirror>
    
    
    <iron-ajax loading="{{loading}}" id="products" url="[[apiRoot]]/wp-json/wc/v2/products" method="get" headers='[[headers]]' content-type="application/json" handle-as="json" last-response="{{productsLive}}"></iron-ajax>
    <app-indexeddb-mirror
        id="productsDb"
        key="products"
        data="{{productsLive}}"
        persisted-data="{{products}}">
    </app-indexeddb-mirror>
    
    
    
    
  </template>
  <script>
    (function(){
      
       
       class EdbApiConsumer extends Polymer.mixinBehaviors( [ Polymer.AppNetworkStatusBehavior ], EdbCataloger(Polymer.Element)) {
         static get is() { return 'edb-api-consumer'; }
         static get properties() {
           return {
             apiRoot: {
               type: String,
               value: 'https://installatex.ca'
             },
             features: {
               type: Array,
               resource: true,
               exposed: true,
               cached: true
             },
             slides: {
               type: Array,
               resource: true,
               exposed: true,
               cached: true
             },
             
             materials: {
               type: Array,
               resource: true,
               exposed: true,
               cached: true
             },
             inspirations: {
               type: Array,
               resource: true,
               exposed: true,
               cached: true
             },
             lookbooks: {
               type: Array,
               resource: true,
               exposed: true,
               cached: true
             },
             pages: {
               type: Array,
               resource: true,
               exposed: true,
               cached: true
             },
             products: {
               type: Array,
               resource: true,
               params: {
                 per_page: 100,
                 embed: 1
                 
               }
             },
             currentProduct:{
               type: Object,
               exposed: true
             },
             about: {
               type: Object,
               exposed: true
             },
             currentUser: {
               type: Object,
               resource: true,
               exposed: true
             },
             jwtAuth: {
               type: Object,
               resource: true,
               exposed: true
             },
             headers: {
               type: Object,
               computed: '_computeHeaders(defaultHeaders,authHeaders)'
             },
             loading: {
               type: Boolean,
               notify: true,
               value: true
             },
             authHeaders: {
               type: Object,
               value: function(){
                 return {};
               }
             },
             defaultHeaders: {
               type: Object,
               value: function(){
                 return {
                   "X-Requested-With": "XMLHttpRequest",
                   "cache-control": "max-stale"
                 };
               }
             },
             subscribers: {
               type: Array,
               value: function(){ return []; }
             },
             sessionToken: {
               type: String,
               computed: '_computeSessionToken(jwtAuth)'
             }
             
           };
         }
         
         
         static get observers(){
           return [
             '_onResponseChanged("about",about)',
             '_onResponseChanged("me",currentUser)',
             '_onResponseChanged("jwt",jwtAuth)',
             '_onJwtAuthChanged(jwtAuth)',
             '_onJwtAuthError(jwtAuthError)'
            ];
         }
         
         _computeSessionToken(auth){
           var token = auth && auth !== null ? auth.token : 'nobody';
           var d = new Date();
           return [token,d.getFullYear(), d.getMonth(), d.getDate() ].join('-')
         }
         _onCurrentUserError(error){
           if(error && error.code && error.code == 'jwt_auth_bad_iss'){
              this.set('jwtAuth', null );
           }
         }
         
         _onJwtAuthChanged(jwtAuth){
           this.$.jwtAuth.body = {};
           if(this._isNotDefined(jwtAuth) || jwtAuth === null){
             this.authHeaders = {};
           }else{
             this.authHeaders = { 'Authorization': 'Bearer ' + jwtAuth.token };
             Polymer.Async.microTask.run( this.$.currentUser.generateRequest.bind(this.$.currentUser) );
           }
         }
         
         
         _computeHeaders(defaultHeaders,authHeaders){
           return Object.assign({},defaultHeaders,authHeaders);
         }
         
         login(user,password){
           this.$.jwtAuth.body={username:user,password:password};
           Polymer.Async.microTask.run( this.$.jwtAuth.generateRequest.bind(this.$.jwtAuth) );
          // Polymer.Async.microTask.run( this.$.currentUser.generateRequest.bind(this.$.currentUser) );
         }
         
         logout(){
           this.set('jwtAuth', null );
           window.location.href = '/';
         }
         
        // _onResourceLoading(type,state){
        //   if(this._isNotDefined(type)) return;
        //   this._updateSubscribers(type+'Loading');
        // }
         _onResponseChanged(type,data){
           if(this._isNotDefined(type,data) && data !== null) return;
          
          // this.dispatchEvent(new CustomEvent(type+'-changed', {detail:  data }));
           this._updateSubscribers(type);
         }
         _onResponseError(type,error){
           if(this._isNotDefined(type,error) && error !== null) return;
           if(error.message){
            error.message = '[' + type + '] ' + error.message;  
           }
          // console.error(type+'-error', error);
          // this.dispatchEvent(new CustomEvent(type+'-error', {detail:  error }));
           this._updateSubscribers(type,error);
         }
         
         _onPagesChanged(pages){
           if(this._isNotDefined(pages)) return;
           pages.forEach( (page)=>{
             if(page.slug == 'about'){
               this.set('about',page)
             }
           })
         }
         
        
         constructor(){
           super();
           var resources = Object.keys(EdbApiConsumer.properties).filter( function( key ){
             return EdbApiConsumer.properties[key].resource === true;
           }).map(function(k){return k});
           var exposed = Object.keys(EdbApiConsumer.properties).filter( function( key ){
             return EdbApiConsumer.properties[key].exposed === true;
           }).map(function(k){return k});
           var cached = Object.keys(EdbApiConsumer.properties).filter( function( key ){
             return EdbApiConsumer.properties[key].cached === true;
           }).map(function(k){return k});
           Object.defineProperty(this,'resources', { value: resources });
           Object.defineProperty(this,'exposed', { value: exposed });
           Object.defineProperty(this,'cached', { value: cached });
           // prep resource observer methods
           resources.forEach( ( prop )=>{
             var propCapName = prop.slice(0,1).toUpperCase() + prop.slice(1);
             var methodName = '_on' + propCapName + 'Changed';
             var errorMethodName = '_on' +propCapName+ 'Error';
             this._createMethodObserver(methodName+'('+prop+')', true);  
             this._createMethodObserver(errorMethodName+'('+prop+'Error)', true);  
             this._createMethodObserver('_onResponseChanged("'+prop+'",'+prop+')', true);
             this._createMethodObserver('_onResponseError("'+prop+'",'+prop+'Error)', true);
            // this._createMethodObserver('_onResourceLoading("'+prop+'",'+prop+'Loading)', true);
             
           });
           
           
         }
         
         
         
         connectedCallback(){
           super.connectedCallback();
           this.cached.forEach( ( id )=>{
            // console.log('cached', id )
             this.$[id].addEventListener('iron-ajax-presend', (event)=>{
               if(this[id]){
                 event.preventDefault();
               }
             });
             
             this.$[id+'Db'].getStoredValue( id ).then( ( value )=>{
               this.set(id, value );
             });

           })
           
           this.resources.forEach( ( id )=>{
             var errorName = id + 'Error';
             this.$[id].addEventListener('last-error-changed', (event)=>{
              var lastResponse = this.$[id].lastResponse;
               var lastError = this.$[id].lastError;
                if(lastError !== null){
                  this.set(errorName,lastError.response);
                }
             });
             this.$[id].addEventListener('error', (event)=>{
               this.set(errorName, event.detail.error );
             });
             var params = EdbApiConsumer.properties[id].params;
             this.$[id].params = params;
            // this.$[id].addEventListener('loading-changed', (event)=>{
            //   this.set(id+'Loading', this.$[id].loading);
            // });
             
           });
           Polymer.Async.idlePeriod.run(()=>{
           this.resources.forEach( (id)=>{
             if( id !== 'jwtAuth'){
              console.log(id)
                 this.$[id].generateRequest();      
           
             }
           } )
           });
           

         }
         
         _updateSubscribers( prop, error){
           this.subscribers.forEach( (element)=>{
             var props = prop ? [ prop ] : this.exposed;
             
              props.forEach( (name) =>{
                if(error){
                  element[name+'Error'] = this[name+'Error'];
                  element.notifyPath(name+'Error',this[name+'Error']);
                }else{
                  element[name] = this[name];
                  element.notifyPath(name,this[name]);
                }
                  
              });     
             
           });
         }
         
         subscribe( element ){
           this.exposed.forEach( (name) =>{
             element._createPropertyAccessor(name);
             element._createPropertyAccessor(name+'Error');
           });  
           this.subscribers.push( element );
           this._updateSubscribers();
         }
         
         /**
          * Checks if arguments are not undefined or empty strings
          *
          * @return {Boolean}
          */
         _isNotDefined() {
           let i;
           for (i = 0; i < arguments.length; i++) {
             if (typeof arguments[i] === 'undefined' || arguments[i] === '') return true;
           }
         }
         
       }
       
       window.customElements.define(EdbApiConsumer.is, EdbApiConsumer);
       
       
       
     })();
  </script>
</dom-module>