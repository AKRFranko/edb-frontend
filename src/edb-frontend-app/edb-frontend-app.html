<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../konami.js"></script>
<script src="../../creds.js"></script>
<script src="../../edb.js"></script>
<script src="../../edb-geonames.js"></script>
<script src="../../edb-checkout.js"></script>
<!--<script src="../../edb-magic.js"></script>-->
<script src="../../edb-resources.js"></script>
<script src="../../edb-polymer.js"></script>
<dom-module id="edb-frontend-app">
  <template>
    <style>
      :host {
        display: block;
        margin:0;
        padding:0;
        box-sizing:border-box;
        max-width:100vw;
        height:100vh;
        overflow-x:hidden;
        overflow-y:auto;
        --edb-font-body: {
          font-family:"pragmatica-web-condensed", 'Helvetica Neue', Helvetica, Arial, sans-serif;
          font-weight:normal;
          font-size:15px;
          line-height:1.25;
          text-transform:lowercase;
        }
        
        --edb-font-title: {
          font-family:'adobe-caslon-pro', Georgia, 'Times New Roman', Times, serif;
          font-weight:normal;
          font-size:22px;
          line-height:1.2;
          text-transform:uppercase;
        }
        
        --edb-font-subtitle: {
          font-family:'adobe-caslon-pro', Georgia, 'Times New Roman', Times, serif;
          font-weight:normal;
          font-size:16px;
          line-height:2;
          text-transform:uppercase;
        }
        
        --edb-font-price: {
          font-family: "pragmatica-web-condensed", 'Helvetica Neue', Helvetica, Arial, sans-serif;
          font-weight: bold;
          font-size: 15px;
          line-height: 1.25;
          text-transform: uppercase;
          margin-bottom: 1.5em;
        }
        --edb-font-headline: {
          font-family: "pragmatica-web-condensed", 'Helvetica Neue', Helvetica, Arial, sans-serif;
          font-size: 45px;
          line-height: 2;
          text-transform: uppercase;
          text-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }
        --edb-font-subhead: {
          font-family:'adobe-caslon-pro', Georgia, 'Times New Roman', Times, serif;
          font-size: 22px;
          text-transform: lowercase;
          line-height: 1.5;
          text-transform: uppercase;
          text-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }
        @apply(--edb-font-body);
      }
      
      a{
        text-decoration:none;
        color:inherit;
        font-weight:bold;
      }
      paper-button{
        font-family: "pragmatica-web-condensed", 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size:13px;
        padding:10px 40px;
        
        background:#000;
        color:#fff;
        border-radius:1px;
        margin-top:20px;
        
      }
      *{
        box-sizing:border-box;
      }
      .edb-title{
        @apply(--edb-font-title);
      }
      .edb-subtitle{
        @apply(--edb-font-subtitle);
      }
      .edb-headline{
        @apply(--edb-font-headline);
      }
      .edb-subhead{
        @apply(--edb-font-subhead);
      }
      
      form{
        @apply(--edb-font-body);
      }
      edb-card,edb-tile{
        background:#fff;
        width:100%;
        height:100%;
        margin:0;
      }
      edb-map{
        min-height:100%;
        min-width:100%;
        max-height:100%;
        max-width:100%;
        width:100%;
        height:100%;
      }
      app-toolbar{
        background:#fff
        padding:0;
      }
      section,edb-page{
        @apply(--layout-vertical);
        display:block;
        
        width:100%;
        min-height:100%;
        margin:0;
        
        /*min-height:100%;*/
        min-width:100%;
        
        
      }
      
      #login paper-input,#register paper-input{
        color:#fff!important;
      }
      .columns{
        width:100%;
        box-sizing:border-box;
        padding:20px;
        @apply(--layout-horizontal);
      }
      .column{
         width:50%;
        box-sizing:border-box;
        padding:20px;
        @apply(--layout-vertical);
      }
      .column > *{
        margin-bottom:40px;
        display:block;
        float:left;
      }
      
      table{
        width:100%;
      }
      edb-map{
        /*width:100vw;*/
        /*height:100vh;*/
        width:100%;
        height:100%;
        /*min-width:100%;*/
        /*min-height:300px;*/
        /*max-width:100%;*/
        /*max-height:100%;*/
      }
      #contact edb-map{
        height:320px;
        widgth:100%;
        
      }
        
      #samplesForm{
        padding:40px;
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }
      #samplesForm .columns{
        padding:0;
        margin-left:-20px;
      }
      paper-dialog{
        background:rgba(0,0,0,0.9);
        color:#fff;
        
      }
      paper-dialog paper-input{
        color:#fff;
        /*--paper-input-container-color: #fff;*/
        --paper-input-container-input-color: #fff;


      }
      #authForm{
        width:320px;
        height:320px;
        box-sizing:border-box;
      }
      #authForm paper-input{
        color:#fff;
      }
      
      #addressForms,#totals{
        width:100%;
        padding:20px;
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        border-top:1px solid #000;
      }
      #totals{
        @apply(--layout-vertical);
        
      }
      #totals .title{
        @apply(--paper-font-title);
        padding:20px;
        margin-bottom:20px;
      }
      #totals .line{
        padding:0 20px;
        @apply(--paper-font-body);
        @apply(--layout-horizontal);
        
      }
      #totals .line-warning{
        /*position:Absolute;*/
        /*width:100%;*/
        /*padding:5px;*/
        /*background:#ff0000;*/
        /*color:#ffffff;*/
      }
      #totals .line[data-warning]{
        background:#ff0000;
        color:#fff;
        padding: 10px 20px;
        @apply(--layout-wrap);
        border-radius:3px;
        margin-top:10px;
        margin-bottom:10px;
      }
      
      #totals .line:first-of-type{
        @apply(--paper-font-title);
        
      }
      #totals .line-label{
        width: 50%;
        height:1em;
        margin:0;padding:0;
        padding-bottom:5px;
        border-bottom: 1px dashed #ccc;

      }
      #totals .line[data-warning] .line-label{
       border-bottom:0; 
      }
      #totals .line-note{
        
        display:inline;
        
      }
      #totals .line-warning{
        background: #fff;
        color: #ff0000;
        border-radius: 0 0 3px 3px;
        padding: 5px;
        width: 60%;
        text-align:center;
      }
      #totals .line-value{
        @apply(--layout-flex);
        text-align:left;
      }
      #addressForms form{
        @apply(--layout-vertical);
        width:50%;
        padding:20px;
      }
      #addressForms form .title{
        @apply(--paper-font-title);
        margin-bottom:20px;
       @apply(--layout-horizontal); 
       @apply(--layout-justified); 
      }
      #addressForms form .title paper-toggle-button{
        @apply(--edb-font-body);
        font-weight:normal;
      }
      #shipping{
        transition:all .2s ease-in;
      }
      #shipping[hidden]{
        visibility:visible;
        display:block!important;
        opacity:0;
      }
      #cart > .title{
        @apply(--paper-font-title);
        padding:20px 40px;
      }
      .twinfields{
        @apply(--layout-horizontal); 
        @apply(--layout-justified); 
      }
      .twinfields > *:first-of-type{
        margin-right:10px;
      }
      .twinfields > *:last-of-type{
        margin-left:10px;
      }
      edb-cart-item{
        border-bottom:1px solid #ccc;
      }
      edb-cart-item:last-of-type{
        border:0;
      }
      .centered-text{
        max-width:700px;
        padding:40px;
        text-align:center;
        margin-left:auto;
        margin-right:auto;
      }
      
      .button-row{
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-justified);
      }
      .todo{
        opacity:0.5;
        background:#eee;
      }
      .zone-suffix{
        @apply(-edb-font-body);
        font-weight:bold;
        background: #999;
        color: #fff;
        padding: 0 3px;
        border-radius: 3px;
        height: 18px;
        font-size: 10px;
        line-height: 18px;
        
        
      }
      .grey-box{
        /*background:#ccc;*/
        border:3px solid #ccc;
        border-radius:3px;
        padding:12px;
      }
      #order .title{
        margin:40px;
      }
      #reset{
        margin:0;
        
        margin-top:100px;
        width:100%;
        background:red;
        color:#fff;
      }
      
      #checkoutAs{
        display:block;
        padding:40px;
        text-align:center;
        background:#eee;
        border-radius:3px;
        margin-top:40px;
        box-sizing:border-box;
        
      }
      #selectBillingCountry paper-listbox paper-item:nth-of-type(3){
        border-bottom:3px dashed #ccc;
      }
    </style>
    <!-- app-location binds to the app's URL -->
    <app-location route="{{route}}" use-hash-as-path></app-location>
    <edb-auth id="auth" user="{{user}}" email="{{authEmail}}" password="{{authPassword}}"></edb-auth>
    <!-- this app-route manages the top-level routes -->
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subRoute}}"></app-route>
    <app-route route="{{route}}" pattern="/products/:filter" data="{{filterData}}"></app-route>
    <app-route route="{{route}}" pattern="/product/:id" data="{{singleProductData}}"></app-route>
    <app-route route="{{route}}" pattern="/order/:id" data="{{orderData}}"></app-route>
    
    
    <edb-layout-query layout="{{layout}}" is-mini-layout="{{isMiniLayout}}"></edb-layout-query>
    <app-scrollpos-control selected="{{page}}"></app-scrollpos-control>
    <app-header-layout fullbleed>
      <app-header condenses reveals>
        <edb-app-toolbar id="toolbar" sticky lang="fr" user="[[user]]" cart="[[cart]]" layout="[[layout]]"></edb-app-toolbar>
      </app-header>
      <div>
        
        <iron-pages attr-for-selected="id" selected="{{page}}">
          
          <section id="home">
            <edb-slider layout="{{layout}}" loading="{{slide.loading}}" slides="{{slide.items}}"></edb-slider>
            <edb-grid layout="{{layout}}" loading="{{feature.loading}}">
              <template is="dom-repeat" items="{{feature.items}}" as="feature">
                <edb-card class$="{{feature.cardType}}" image="{{feature.image.src}}" title="{{feature.title.en}}" subtitle="{{feature.subtitle.en}}">
                  <p>{{limitText(feature.content.en,120)}}</p>
                </edb-card>
              </template>
            </edb-grid>
          </section>
          
          <section id="order">
            <div class="title edb-title">Order #{{order.id}}</div>
            <edb-order-details order="{{order}}"></edb-order-details>
          </section>
          
          <section id="cart">
            <div class="title">Cart</div>
            <template is="dom-repeat" items="{{cart}}" as="cartItem">
              <div class="cart-item">
                <edb-cart-item item="[[cartItem]]" materials="[[material.items]]">
                    <paper-button on-tap="handleRemoveCartItem">remove</paper-button>
                </edb-cart-item>
                
                
              </div>
              
            </template>
            <div hidden$="{{cart.length}}"><p style="padding:40px;">Your cart is empty.</p></div>
            
            <template is="dom-if" if="{{user}}">
            
            <div id="addressForms" hidden$="{{!cart.length}}">
              <form id="billing">
                <div class="title">Billing Address
                  <paper-toggle-button on-change="handleAddressToggleChanged" checked$="{{customer.useBillingAddressForShipping}}">use for shipping</paper-toggle-button>
                </div>
                <div class="twinfields">
                  <paper-input label="first name" value="{{customer.billing_first_name}}" auto-validate required></paper-input>
                  <paper-input label="last name" value="{{customer.billing_last_name}}"></paper-input>
                </div>
                <paper-input label="company" value="{{customer.billing_company}}"></paper-input>
                <div class="twinfields">
                  
                  <paper-input label="telephone" value="{{customer.billing_phone}}" auto-validate required></paper-input>
                  <paper-input label="email" value="{{customer.billing_email}}" auto-validate required></paper-input>
                </div>
                
                <paper-input label="address" value="{{customer.billing_address_1}}" auto-validate required></paper-input>
                <div class="twinfields">
                  <paper-dropdown-menu id="selectBillingCountry" label="country">
                    <paper-listbox class="dropdown-content" attr-for-selected="data-country" selected="{{billingCountrySelection}}" fallback-selection="CA">
                      <template is="dom-repeat" items="[[listOfCountries]]" as="country">
                        <paper-item data-country="[[country.code]]">[[country.name.en]]</paper-item>  
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>
                  <!--<paper-input label="country" value="{{customer.billing_country}}" auto-validate required></paper-input>-->
                  <paper-input hidden$="[[showListOfProvinces]]" label="state" value="{{customer.billing_state}}" auto-validate required></paper-input>
                  <paper-dropdown-menu hidden$="[[!showListOfProvinces]]" id="selectBillingProvince" label="state" >
                    <paper-listbox class="dropdown-content" attr-for-selected="data-province" selected="{{billingStateSelection}}" fallback-selection="QC" auto-validate required>
                      <template is="dom-repeat" items="[[listOfProvinces]]" as="province">
                        <paper-item data-province="[[province.code]]">[[province.name.en]]</paper-item>  
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>
                </div>
                <div class="twinfields">
                  <paper-input label="city" value="{{customer.billing_city}}" auto-validate required></paper-input>
                  <paper-input label="postal_code" value="{{customer.billing_postcode}}" required$="{{customer.useBillingAddressForShipping}}">
                    <div suffix hidden$="{{!customer.useBillingAddressForShipping}}" auto-validate on-keyup="__updateShippingZone" class="zone-suffix">{{shippingZone}}</div>
                  </paper-input>
                  
                </div>
              </form>
              <form id="shipping" hidden$="{{customer.useBillingAddressForShipping}}">
                <div class="title">Shipping Address</div>
                <div class="twinfields">
                  <paper-input label="first name" value="{{customer.shipping_first_name}}" auto-validate required></paper-input>
                  <paper-input label="last name" value="{{customer.shipping_last_name}}"></paper-input>
                </div>
                <paper-input label="company" value="{{customer.shipping_company}}"></paper-input>
                <div class="twinfields">
                  <paper-input label="telephone" value="{{customer.shipping_phone}}" auto-validate required$="{{!customer.useBillingAddressForShipping}}"></paper-input>
                  <paper-input label="email" value="{{customer.shipping_email}}" auto-validate required$="{{!customer.useBillingAddressForShipping}}"></paper-input>
                </div>
                <paper-input label="address" value="{{customer.shipping_address_1}}" auto-validate required$="{{!customer.useBillingAddressForShipping}}"></paper-input>
                <div class="twinfields">
                  <paper-dropdown-menu id="selectShippingCountry" label="country">
                    <paper-listbox class="dropdown-content" attr-for-selected="data-country" selected="{{customer.shipping_country}}" fallback-selection="CA" readonly>
                        <paper-item data-country="CA">Canada</paper-item>  
                    </paper-listbox>
                  </paper-dropdown-menu>
                  <!--<paper-input label="state" value="{{customer.shipping_state}}" auto-validate required$="{{!customer.useBillingAddressForShipping}}"></paper-input>-->
                  <paper-dropdown-menu id="selectShippingProvince" label="state">
                    <paper-listbox class="dropdown-content" attr-for-selected="data-province" selected="{{customer.shipping_state}}" fallback-selection="QC" auto-validate required$="{{!customer.useBillingAddressForShipping}}">
                      <template is="dom-repeat" items="[[listOfProvinces]]" as="province">
                        <paper-item data-province="[[province.code]]">[[province.name.en]]</paper-item>  
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>
                </div>
                <div class="twinfields">
                  <paper-input label="city" value="{{customer.shipping_city}}" auto-validate required$="{{!customer.useBillingAddressForShipping}}"></paper-input>
                  <paper-input label="postal_code" value="{{customer.shipping_postcode}}" auto-validate on-keyup="__updateShippingZone" required$="{{!customer.useBillingAddressForShipping}}">
                    <div suffix class="zone-suffix">{{shippingZone}}</div>
                    
                  </paper-input>
                </div>
              </form>  
              <form id="payment" class="todo">
                <div class="title">Payment</div>
                <div class="twinfields">
                <paper-input read-only label="first name" value="[[customer.billing_first_name]]"></paper-input>
                <paper-input read-only label="last name" value="[[customer.billing_last_name]]"></paper-input>
                </div>
                <gold-cc-input label="Credit Card Number"></gold-cc-input>
                <div class="twinfields">
                  <gold-cc-cvc-input label="Verification"></gold-cc-cvc-input>
                  <gold-cc-expiration-input label="Expiration"></gold-cc-expiration-input>
                </div>
              </form>
              <form id="coupon">
                
                <div class="grey-box">
                  <div class="title">Coupon</div>
                  <p>Have a coupon?</p>
                  <paper-input always-float-label class="coupon-code" value="{{couponCode}}" label="Coupon Code" on-change="applyCoupon"></paper-input>
                </div>
                
                <br />
                <div class="grey-box" hidden$="{{!isUserDesigner(user.designer_meta)}}">
                  <div class="title">You're a designer!</div>
                  <p>You get 5% off regular priced items!</p>
                </div>
              </form>
            </div>
            
            <div id="totals" hidden$="{{!cart.length}}">
              <div class="title">Totals</div>
              <template is="dom-repeat" items="{{cartTotals}}" as="line">
                <div class="line" data-warning$="{{line.warning}}">
                  <div class="line-label">{{line.label}} <span class="line-note">{{line.note}}</span></div>
                  <div class="line-value">{{formatMoney(line.value)}}</div>
                  <div class="line-warning" hidden$="{{!line.warning}}">{{line.message}}</div>
                </div>
                
              </template>
              <paper-button on-tap="createOrder">complete order</paper-button>
            </div>
            
            </template><!-- dom if logged in -->
            
            <div id="checkoutAs" hidden$="{{user}}">
              <paper-button on-tap="openAuthDialog">please login to checkout</paper-button>
            </div>
            
          </section>
          <section id="product">
            
            <edb-product-page product="[[product.item]]" cart="[[cart]]" materials="[[material.items]]"></edb-product-page>
            
            
          </section>
          <section id="products">
              <iron-pages selected="[[filterData.filter]]" attr-for-selected="data-filter" fallback-selection="all" selectable="div.filtered">
                  <template is="dom-repeat" items="[[filters]]" as="filter">
                    <div class="filtered" data-filter$="[[filter]]">
                      <edb-grid layout="[[layout]]" loading="[[product.loading]]">
                        <template is="dom-repeat" items="{{catalog}}" as="entry" filter="[[_filterCatalog(filter)]]">
                          <a href="[[computeCatalogItemUrl(entry)]]" tabindex="-1">
                          <edb-card image="[[entry.product.images.0.src]]" title="[[entry.name]]" subtitle="[[formatProductPrice(entry.product.price)]]">
                            <p>[[limitText(entry.product.description.en,120)]]</p>
                          </edb-card>
                          </a>
                        </template>
                      </edb-grid>
                    </div>  
                  </template>
              </iron-pages>
            
          </section>
          
          <section id="inspiration">
            <edb-page title="Elements of inspiration" no-image>
              <p class="centered-text">in this section, we present a collection of our favourite snap shots from our photo sessions. each week, we select and add images that we like. random angles, interesting details, creative decors, cosy textures, beautiful colors or dynamic configurations.
                no specific function other than to inspire beauty and style around us. these are our feel good pics! happy viewing.</p>
              <edb-grid layout="{{layout}}" loading="{{inspiration.loading}}">
                <template is="dom-repeat" items="{{inspiration.items}}" as="inspiration">
                  <edb-card image="{{inspiration.image.src}}" no-icon class="square">
                    <p class="edb-title">{{inspiration.title.en}}</p>
                  </edb-card>
                </template>
              </edb-grid>
            </edb-page>
          </section>
          <section id="contact">
            <edb-page title="Contact" image="http://installatex.ca/wp-content/uploads/2017/03/contact.jpg">
              <div class="columns">
                <div class="column">
                  <article class="address">
                     <h3 class="edb-title">ADDRESS</h3>
 <span class="street-address">534 mccaffrey</span>
 <span class="locality">montreal, qc</span>
 <span class="postcode">h4t 1n1</span>

                    <br> <span class="phone">514-738-6484</span>
 <span class="phone">1-844-738-6484</span>
 <span class="email"><a href="mailto:info@elementdebase.com">info@elementdebase.com</a></span>

                  </article>
                  <article class="map">
                    <edb-map></edb-map>
                    <p>our showroom is conveniently located in montreal near the junction of the 40 and the 13.</p>
                    <p>approximate time without heavy traffic:</p>
                    <ul>
                      <li>5 min from trudeau airport</li>
                      <li>25 min from downtown montreal</li>
                      <li>30 min from olympic stadium</li>
                      <li>25 min from outremont</li>
                      <li>20 min from tmr</li>
                      <li>30 min from the plateau</li>
                      <li>25 min from the mile end</li>
                      <li>2 min from ikea (cavendish)</li>
                      <li>15 min from ville st-laurent</li>
                      <li>5 min from plaza cote-vertu</li>
                    </ul>
                  </article>
                </div>
                <div class="column">
                  <article class="showroom">
                     <h3 class="edb-title">SHOWROOM OPEN TO THE PUBLIC</h3>

                    <table>
                      <tr>
                        <th>mon – tue</th>
                        <td>by appointment*</td>
                      </tr>
                      <tr>
                        <th>wed</th>
                        <td>12h00 to 18h00</td>
                      </tr>
                      <tr>
                        <th>thu - fri</th>
                        <td>12h00 to 20h00</td>
                      </tr>
                      <tr>
                        <th>sat - sun</th>
                        <td>13h00 to 17h00</td>
                      </tr>
                    </table>
                    <p class="edb-footnote">* to arrange an appointment, please call us within our opening hours or write to us at least 24 hours in advance at
                      <a href="mailto:info@elementdebase.com">info@elementdebase.com</a>
                    </p>
                    <p>Our showroom is open to the public. everyone is welcome to pass by during our opening hours.</p>
                  </article>
                  <article class="form">
                    <form id="contactForm">
                       <h3 class="edb-title">WRITE TO US</h3>

                      <p>we'll respond within 24 hours</p>
                      <paper-input label="name" type="text"></paper-input>
                      <paper-input label="email" type="email"></paper-input>
                      <paper-input label="confirm email" type="email"></paper-input>
                      <paper-input label="phone number" type="tel"></paper-input>
                      <paper-input label="subject" type="text"></paper-input>
                      <paper-textarea rows="5" label="your message"></paper-textarea>
                      <paper-button>send</paper-button>
                    </form>
                  </article>
                </div>
                <div>
            </edb-page>
          </section>
          <section id="order-samples">
            <edb-page title="Order Samples" image="http://installatex.ca/wp-content/uploads/2017/03/samples.jpg">
              <form id="samplesForm">
                <p>order your free fabric samples to validate your choice at home. you will receive by mail our complete collection of upholstery fabrics. please allow 2-4 business days depending on where you are located in canada.</p>
                <p>samples are only available for sofa fabrics, not for accessories such as throw cushions.</p>
                <div class="columns">
                  <div class="column">
                    <div>
                      <paper-input label="name" type="text"></paper-input>
                      <paper-input label="email" type="email"></paper-input>
                      <paper-input label="confirm email" type="email"></paper-input>
                    </div>
                  </div>
                  <div class="column">
                    <div>
                      <paper-input label="street address" type="text"></paper-input>
                      <paper-input label="province" type="text"></paper-input>
                      <paper-input label="city" type="text"></paper-input>
                      <paper-input label="postal code" type="text"></paper-input>
                      <paper-button>send</paper-button>
                    </div>
                  </div>
                </div>
              </form>
            </edb-page>
          </section>
          <!--<edb-slider layout="{{layout}}"></edb-slider>-->
        </iron-pages>
        <paper-button id="reset" on-tap="resetStocks">RESET STOCKS</paper-button>
        </div>
    </app-header-layout>
    <paper-dialog modal id="authDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <form id="authForm" on-submit="handleAuthFormSubmit" on-keydown="submitOnEnterKey">
        <div class="edb-title">Welcome</div>
        <iron-pages attr-for-selected="id" selected="{{authMode}}" fallback-selection="authModeSelect">
          <div id="authModeSelect">
            <iron-selector selected="{{authMode}}" attr-for-selected="data-select" fallback-selection="authModeSelect">
              <paper-item data-select="login">
                <paper-item-body two-line>
                  <div>Returning Customers</div>
                  <div secondary>Please <b>sign in</b>
                  </div>
                </paper-item-body>
              </paper-item>
              <paper-item data-select="register">
                <paper-item-body two-line>
                  <div>New Customers</div>
                  <div secondary><b>Sign Up</b> for shopping and exclusive offers</div>
                </paper-item-body>
              </paper-item>
            </iron-selector>
          </div>
          <div id="login">
            <paper-input type="email" label="Email" value="{{authEmail}}"></paper-input>
            <paper-input type="password" label="Password" value="{{authPassword}}"></paper-input>
            <div class="button-row">
              <a href="/#" on-tap="setAuthModeRegister">register instead</a>
              <paper-button on-tap="handleLogin">login</paper-button>
            </div>
          </div>
          <div id="register">
            <paper-input type="email" label="Email" value="{{authEmail}}"></paper-input>
            <paper-input type="password" label="Password" value="{{authPassword}}"></paper-input>
            <paper-input type="password" label="Confirm Password" value="{{authPasswordConfirmation}}"></paper-input>
            <div class="button-row">
              <a href="/#" on-tap="setAuthModeLogin">login instead</a>
              <paper-button on-tap="handleRegister">register</paper-button>
            </div>
          </div>
        </iron-pages>
      </form>
    </paper-dialog>
    <iron-ajax id="geogratis"
      auto
      url="http://geogratis.gc.ca/services/geoname/en/geonames.json"
      params='{{geogratisParams}}'
      handle-as="json"
      last-response="{{geogratisResponse}}"
      debounce-duration="300"></iron-ajax>
  </template>
  <script>
    function isDescendant(parent, child) {
         var node = child.parentNode;
         while (node != null) {
             if (node == parent) {
                 return true;
             }
             node = node.parentNode;
         }
         return false;
    }
      Polymer({
  
        is: 'edb-frontend-app',
  
        properties: {
          user: {
            type: Object,
            notify: true
          },
          route: {
            type: Object,
            notify: true
          },
          routeData: {
            type: Object,
            notify: true
          },
          orderData: {
                     type: Object,
                     notify: true
                   },
          page: {
            type: String,
            value: 'home',
            notify: true
          },
          couponCode: {
                      type: String,
                      value: null,
                      notify: true
                    },
          slide:{
            type: Object,
            notify: true,
            value: function(){
              return {};
            }
          },
          
          feature:{
            type: Object,
            notify: true,
            value: function(){
              return {};
            }
          },
          product:{
            type: Object,
            notify: true,
            value: function(){
              return {};
            }
          },
          material:{
            type: Object,
            notify: true,
            value: function(){
              return {};
            }
          },
          
          inspiration:{
            type: Object,
            notify: true,
            value: function(){
              return {};
            }
          },
          cart: {
            type: Array,
            notify: true,
            value: function(){
              return [];
            }
          },
          authMode: {
            type: String,
            value: 'authModeSelect',
            notify: true
          },
          filters: {
            type: Array,
            value: function(){
              return ['all','sofas', 'sofas-1-seat','sofas-2-seat','sofas-3-seat','sofas-sectional','sofas-sectional-left','sofas-sectional-right'];
            }
          },
          query: {
            type: Object,
            notify: true,
            value: function(){
              return {};
            }
          },
          cartTotals: {
            type: Array,
            notify: true,
            value: function(){
              return [];
            }
          },
          shippingZone: {
            type: String,
            notify: true,
            value: 'zone-3'
          },
          listOfCountries: {
            type: Array,
            notify: true,
            value: function(){ return [];}
          },
          listOfProvinces: {
            type: Array,
            notify: true,
            value: function(){ return [];}
          },
          billingCountrySelection: {
            type: String,
            notify: true,
            value: 'CA',
            observer: '_billingCountrySelectionChanged'
          },
          billingStateSelection: {
                                   type: String,
                                   notify: true,
                                   value: 'QC',
                                   observer: '_billingStateSelectionChanged'
                                 },
          showListOfProvinces: {
            type: Boolean,
            notify: true,
            value: true
          }
          
        },
        observers: ['routePage(route,routeData)','closeAuthDialog(user)','setSelectedProductId(singleProductData.id)','computeCartTotals(cart,customer,cart.*,customer.*)','computeShippingZone(customer.billing_postcode,customer.shipping_postcode,customer.useBillingAddressForShipping)'],
        computeLineClass: function( line ){
          if(line && line.warning) return 'line warning';
          return 'line';
        },
        _billingCountrySelectionChanged: function( value ){
          this.set('customer.billing_country', value );
          this.set('customer.billing_state', null );
          if(value == 'CA'){
            this.set('showListOfProvinces', true );
          }else{
            this.set('showListOfProvinces', false );
            
          }
        },
        _billingStateSelectionChanged: function( value ){
          this.set('customer.billing_state', value );
          
        },
        
        submitOnEnterKey: function(e){
          if(e.which == 13){
            this.handleAuthFormSubmit(e);    
          }
          
        },
        log: function( m ){
          console.log(m)
        },
        handleAuthFormSubmit: function( e ){
          if(e){
            e.preventDefault();  
          }
          if(this.authMode =='login'){
            this.handleLogin();  
          }else{
            this.handleRegister();  
          }
        },
        resetStocks: function(){
          EDB.resetStocks();
        },
        closeAuthDialog: function( user ){
          this.$.authDialog.close();
        },
        openAuthDialog: function( user ){
          this.$.authDialog.open();
        },
        createOrder: function(){
          EDB.Checkout.createOrder();
        },
        setSelectedProductId: function( id ){
          if(this.get('product')){
            this.set('product.selectedId',id);  
          }
          
          // console.log('product.selectedId',id);
        },
        isUserDesigner: function( meta ){
          return meta && meta.designer_level !== 'none';
          
        },
        computeShippingZone: function( billing,shipping, useBilling ){
          
          
          if(useBilling === true){
            this.set('shippingZone', EDB.Checkout.getZone( billing ) );
            console.log('computeShippingZone',EDB.Checkout.getZone( billing ) , billing);
          }else{
            this.set('shippingZone', EDB.Checkout.getZone( shipping )  );
            console.log('computeShippingZone',EDB.Checkout.getZone( shipping ) , shipping);
          }
          
          // return EDB.Checkout.getZone( code );
        },
        applyCoupon: function(){
          EDB.Checkout.applyCoupon( this.get('couponCode'))
        },
        removeCoupon: function( name ){
          EDB.Checkout.removeCoupon( name );
        },
        setAuthModeRegister: function( e )
        {
          e.preventDefault();
          this.set('authMode', 'register');
          console.log(this.get('authMode'))
        },
        formatProductPrice: function( p ){
          return this.formatMoney( p );
        },
        setAuthModeLogin: function( e ){
          e.preventDefault();
          
          this.set('authMode', 'login');
          console.log(this.get('authMode'))
        },
        handleAddressToggleChanged: function( event ){
          var el = Polymer.dom(event).localTarget;
          // console.log('handleAddressToggleChanged', el.checked );
          this.set('customer.useBillingAddressForShipping', el.checked);
          EDB.Checkout.useBillingAddressForShipping = el.checked;
        }, 
        computeCartTotals: function(){
          this.set('cartTotals', []);
          this.async( function(){
            this.set('cartTotals', EDB.Checkout.computeCartTotals());
          })
        },
        __updateShippingZone: function(){
          var customer = this.get('customer');
          if(customer){
            this.computeShippingZone(customer.billing_postcode,customer.shipping_postcode,customer.useBillingAddressForShipping);
          }
          
          
        },
        _filterCatalog: function( filterVal ){
          var days30  =1000 * 60 * 60  * 24  * 30;
          return function( entry ) {
            var product = entry.product;
            if (!filterVal) return true;
            if (!product) return false;
            if( filterVal == 'all'){
             return true; 
            }else if(filterVal == 'new'){
             return Date.now() - product.created < days30;
            }else if(filterVal =='sale'){
             return product.isOnSale;
            }else{
              return product.categories.some( function( c ){
                
                 return c.slug == filterVal; 
              });  
            }
            
          };
        },
        computeCatalogItemUrl: function( entry, qs ){
            var product = entry.product;
            var id = product.id;
            var bucketAttributes = product.attributes.filter( function( attr ){
            return product.isBucketOption;
            } ).map( function( attr ){ return attr.name + '=' + attr.option; });
            // console.log('computeCatalogItemUrl',entry)
            return '/#/product/'+id+'/?'+QSJS().encode(entry.option);
        },
        computeCatalogItemName: function( item ){
          
          var names = [ item.name ];
          var bucketAttributes = item.attributes.filter( function( attr ){
            return attr.isBucketOption;
          } ).map( function( attr ){ return attr.option });
          return names.concat(bucketAttributes).join(' ');
        },
        _onlyBuckets: function( products ){
          return products.filter( function( p ){
            return p.meta.edb_is_bucket == '1';
          });
        },
        _onlyObjects: function(products){
          return products.filter( function( p ){
            return p.meta.edb_is_bucket != '1';
          })
        },
        // computeCatalogItems: function( products ){
        //   if(!products) return [];
        //   return products;
        //   var bucketsArray = this._onlyBuckets( products );
        //   var objectsArray = this._onlyObjects( products );
        //   objectsArray = objectsArray.map( function( o ){ 
        //     var variations = o.variations;
        //     var newVariations = [];
        //     o.attributes.forEach( function( attribute ){
        //       var attributeBuckets = bucketsArray.filter( function( item ){ return item.meta.edb_bucket_slug == 'edb_'+attribute.name; } );
        //       if(attributeBuckets.length > 0){
        //         attributeBuckets.forEach( function(attributeBucket){
        //             attribute.bucketOptions = attributeBucket.variations.filter( function( bvar ){
        //               return ~attribute.options.indexOf(bvar.attributes[0].option);
        //             });
        //             attribute.bucketOptions.forEach( function( option ){
        //               variations.forEach( function( variation ){
        //                 var vattr= variation.attributes;
        //                 vattr.push( option.attributes[0] );
        //                 newVariations.push( Object.assign(variation, { attributes: vattr }));
        //               })
        //             })
        //         });
        //       }else{
        //         newVariations = variations;
        //       }
        //     });
        //     o.variations = newVariations;
        //     return o;
        //   });
          
        //   // console.log(objectsArray);
        //   return objectsArray;
        //   var catalog= [];
           
        //   return catalog;
        // },
        handleLogin: function(){
          this.$.auth.login();
        },
        handleRegister: function(){
          this.$.auth.register();
        },
        handleLogout: function(){
          this.$.auth.logout();
        },
        handleRemoveCartItem: function( event ){
          event.model.cartItem.remove();
          
        },
        routePage: function( route,data ){
          this.debounce('routePAge', function(){
            if(!data || ( data && !data.page)){
              this.set('page', 'home');
            }else{
              this.set('page',data.page);
              if(data.page == 'order'){
                EDB.Checkout.loadOrder(this.get('orderData').id, this );
                console.log('ORDER PAGE' );
              }
            }  
          });
          
        },
       
        limitText: function( t,n ){
          return t.slice(0,n)+'...';
        },
        formatMoney: function( amount ){
          return EDB.format.money( amount );
        },
        attached: function(){
          
          
          var slide = new EDB.PolymerResource('slide', this);
          slide.refreshItems();
          
          var feature = new EDB.PolymerResource('feature', this);
          feature.refreshItems();
          
          // var inspiration = new EDB.PolymerResource('inspiration', this);
          // inspiration.refreshItems();
          var it = this;
          this.$.toolbar.dialog = this.$.authDialog;
          this.$.authDialog.noCancelOnEscKey=false;
          this.$.authDialog.noCancelOnOutsideClick=false;
          
          var product = new EDB.PolymerResource('product', this);
          product.refreshItems().then( function(){
            EDB.Checkout.init( it, product.items );
            
          })
          
          var material = new EDB.PolymerResource('material', this);
              material.refreshItems();
          new Konami(function() { 
            
            alert('Godmode ACtivated!');
          });
          
          EDB.Geonames.init( this);
          // this.set('slides', slides.items );
          // console.log()
        }
  
      });
  </script>
</dom-module>