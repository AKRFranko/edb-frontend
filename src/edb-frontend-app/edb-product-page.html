<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="edb-product-page">
  <template>
    <style>
      :host{
        display:block;
        width:100%;
        height:100%;
        
      }
      *{
        box-sizing:border-box;
      }
      paper-button{
        font-family: "pragmatica-web-condensed", 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size:13px;
        padding:10px 40px;
        
        background:#000;
        color:#fff;
        border-radius:1px;
        margin-top:20px;
        
      }
      #page{
        display:block;
        width:100%;
        max-width:100vw;
        overflow-x:hidden;
        min-height:100%;
        @apply(--layout-vertical);
        @apply(--edb-font-body);
      }
      .page-header{
        position:relative;
        width:100%;
        height:0;
        padding-top:calc(100vh - 140px);
       
      }
      .page-body{
        /*background:Red;*/
        padding:20px;
      }
      
      .header-inner,.header-split{
        position:absolute;
        width:100%;
        height:100%;
        top:0;left:0;bottom:0;right:0;
        @apply(--layout-vertical);
        /*@apply(--layout-center-center);*/
        z-index:0;
        
      }
      #slideWrapper{
        position:relative;
      }
      edb-slider{
        /*background:#000;*/
        
        
      }
      
      .header-split{
        position:relative;
        @apply(--layout-horizontal);
        width:100%;
        height:100%;
        
      }
      edb-slider{
        position:absolute;
        /*width:768px;*/
        /*height:calc(0.63 * 768px);*/
        width:100%;
        height:100%;
        top:0;
        left:0;
        bottom:0;
        right:0;
      }
      .page-title{
        @apply(--edb-font-headline);
        color:#fff;
        line-height:1.2;
        white-space:nowrap;
        text-overflow:ellipsis;
        z-index:1;
        overflow:hidden;
      }
      .page-subtitle{
        @apply(--edb-font-subhead);
        color:#fff;
        z-index:1;
      }
      
      #productMenu{
        display:block;
        width:calc(100% - 768px);
        color:#000;
        box-sizing:border-box;
        padding:0 40px 40px 20px;
        /*@apply(--layout-vertical);*/
        /*@apply(--layout-start-justified);*/
      }
      
      #productMenu .name{
        @apply(--edb-font-title);
        line-height:1.3;
        margin-bottom:1.7rem;
      }
      #productMenu .price{
        @apply(--edb-font-subtitle);
      }
    
      .attribute-label{
        @apply(--edb-font-body);
        padding:10px 0;
      }
      iron-selector{
        width:100%;
        margin:0;
        padding:0;
        /*background:#fcfcfc;*/
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        box-sizing:border-box;
      }
      iron-selector paper-button{
        @apply(--layout-flex);
        background:#fefefe;
        color:#000;
        margin:10px 0;
        padding:0;
        border:2px solid transparent;
        transition:all .2s ease-in;
      }
      iron-selector paper-button.iron-selected{
        border-color:#000;
      }
      iron-selector.slipcover{
        margin-left:-3px;
        margin-right:3px;
      }
      
      iron-selector.slipcover paper-button{
        margin:0;
        padding:0;
        border-radius:0;
        width:40px;
        min-width:40px;
        max-width:40px;
        height:40px;
        min-height:40px;
        max-height:40px;
        
        
        position:relative;
        box-sizing:border-box;
        
        border:0;
      }
      iron-selector.slipcover paper-button.iron-selected{
        border-color:transparent;
      }
      .availability-icon{
        position:absolute;
    
        width: 13px;
        height: 13px;
        background:rgba(255,255,255,0.25);
        color: rgba(0,0,0,0.75);
        border-radius:50%;
        right: 7px;
        bottom: 7px;
    
      }
      iron-selector.slipcover paper-button iron-image{
        position:absolute;
        width:calc(100% - 4px);
        height:calc(100% - 4px);
        top:0;
        left:0;
        bottom:0;
        right:0;
        box-sizing:border-box;
        margin:1px;
        border:2px solid transparent;
        transition:all .2s ease-in;
      }
      iron-selector.slipcover paper-button.iron-selected iron-image{
        border-color:#000;
      }
      .product-quantity,.availability-group{
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        
        width:100%;
      }
      .product-quantity paper-input{
        max-width:3rem;
        margin-left:0.5rem;
        margin-right:0.5rem;
        
        text-align:center;
        --paper-input-container:{
          font-size:1.3rem;
        }
        --paper-input-container-underline: {
          display:none;
        }
        margin-top:-0.3rem;
      }
      .product-options{
       @apply(--layout-vertical);
       margin-top:1.5rem;
       height:auto;
      }
      .lower,.increase{
        border-radius:50%;
        background:#fff;
        color:#000;
        width:1.5em;
        height:1.5em;
        padding:2px;
      }
      
      .product-description{
        @apply(--layout-vertical);
        text-align:center;
      }
      
      .group{
        display:block;
        width:100%;
        /*height:100%;*/
        
      }
      
      .quantity-group{
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        border-top:1px solid #000;
      }
      .availability-group{
        border-top:1px solid #000;
      }
      #addToCart{
        /*float:right;*/
        margin-right:20px;  
        margin-top:20px;
        /*@apply(--layout-self-end);*/
      }
      
      @media all and (max-width:768px){
       .header-split{
         @apply(--layout-vertical);
       } 
       #productMenu{
         width:100%;
         padding-top:40px;
        @apply(--layout-horizontal); 
        @apply(--layout-wrap); 
       }
       .product-options{
         @apply(--layout-horizontal);
         
       }
        edb-slider{
          /*width:100%;*/
          /*height:60%;*/
        }
        edb-slider ::content .slide,edb-slider ::content #wrapper{
          /*height:60vh;*/
          
        }
        .attribute-group{
          width:50%;
        }
        
      }
      @media all and (min-width:769px){
        .header-split{
          padding:0 40px;
        }
        #productMenu{
          padding:0 40px 40px 40px;
          min-width:300px;
          
        }
        iron-selector.slipcover{
          /*max-width:300px;*/
          
        }
        .product-options{
          @apply(--layout-vertical);
        }
        #addToCart{
         
          margin-right:40px;
          
        }
        edb-slider{
          /*width:768px;*/
          /*height:483px;*/
        }
        edb-slider ::content .slide,edb-slider ::content #wrapper{
          /*height:483px;*/
          
        }
        .page-body{
          padding:40px;
        }
        .text{
          max-width:500px;
        }
        
      }
      
      @media all and (min-width:800px){
        .text{
          max-width:768px;
        }
      }
      
      .title{
        @apply(--edb-font-title);
        
        padding-bottom:0.5rem;
        text-align:center;
      };
      .text{
        padding:40px 0;
        text-align:center;
        margin-left:auto;
        margin-right:auto;
      }
      .product-description{
        margin-bottom:40px;
        padding-top:40px;
        border-top:1px solid #000;
      }
      .product-description iron-image{
        max-width:100%;
        width:100%;
      }
      .product-description iron-image ::content img{
        max-width:100%;
        width:100%;
      }
      #slideWrapper{
        display:inline-block;
        width:100%;
        height:100%;
      }
    </style>
    
    <div id="page">
      <div class="page-header">
        <div class="header-inner">
          
         <div class="header-split">
           <!--<div class="cart-item-total">${{product.price}}</div>-->
           <div id="slideWrapper">
              <edb-slider id="slider" layout="[[layout]]" loading="false" slides="{{slides}}"></edb-slider> 
           </div>
            
            <div id="productMenu">
              <div class="group">
                <div class="name">{{product.name}}</div>
                <div class="price">{{formatMoney(price)}}</div>
              </div>
              <div class="product-options">
                <template is="dom-repeat" items="{{computeAttributes(product,materials)}}" as="attribute">
                  <div class="group">
                    <edb-dropdown group="product-options" label="{{attribute.name}}">
                      <iron-selector class$="{{attribute.name}}" on-selected-changed="handleSelectedAttributeChanged">
                        <template is="dom-repeat" items="[[computeAttributeChoices(attribute,product.variations)]]" as="choice">
                          <paper-button class$="[[choice.classnames]]" data-value$="[[choice.option]]">
                            <iron-image preload fade sizing="cover" class="choice-icon" hidden$="[[!choice.icon]]" src="[[choice.icon]]"></iron-image>
                            <div class="choice-label" hidden$="[[!choice.label]]">[[choice.label]]</div>
                            <iron-icon class="availability-icon" icon$="{{computeStockIcon(product.id,attribute,choice,attributes,attributes.*,cart.*)}}"></iron-icon>
                          </paper-button>
                        </template>
                      </iron-selector>  
                    </edb-dropdown>
                  </div>
                  
                </template>
              </div>
              <div class="group attribute-group quantity-group">
                <div class="attribute-label">Quantity</div>
                <div class="product-quantity">
                  <paper-icon-button class="lower" on-tap="decrQty" icon="remove"></paper-icon-button>
                  <paper-input no-label-float label="qty" value="{{wantedQty}}"></paper-input>
                  <paper-icon-button class="increase" on-tap="incrQty" icon="add"></paper-icon-button>
                </div>
              </div>
              
              <div class="group attribute-group availability-group">
                <div class="attribute-label">Availability</div>
                <div class="product-availability">
                    00/00/000
                </div>
              </div>
            
              <div class="add-to-cart attribute-group">
                <paper-button id="addToCart" on-tap="handleAddToCart">add to cart</paper-button>
              </div>
              
            
            </div>
        </div>
        </div>
      </div>
    
      <div class="page-body">
        <div class="page-content">
          <div class="product-description">
            <div class="title">Description</div>
            <div class="text">{{product.description.en}}</div>
          </div>
          
          <div class="product-description" hidden$="{{!product.meta.edb_why_we_love_title}}">
            <div class="title">{{product.meta.edb_why_we_love_title}}</div>
            <div class="text">{{product.meta.edb_why_we_love_content}}</div>
          </div>
          <div class="product-description" hidden$="{{!product.meta.edb_anatomy_en}}">
            <iron-image src="{{__computeAnatomy(product.meta.edb_anatomy_en)}}" style="width:100%;height:100%;"></iron-image>
          </div>
        </div>
      </div>
      
    </div>
    
  </template>
  <script>
     
      Polymer({
  
        is: 'edb-product-page',
  
        properties: {
          
          layout: {
            type: String,
            value: null,
            notify: true
          },
          product: {
            type: Object,
            value: function(){
              return {};
            },
            notify: true
          },
          cart: {
            type: Array,
            
            notify: true
          },
          changed: {
            type: Number,
            notify: true,
            value: null
          },
          materials: {
            type: Array,
            value: function(){
              return [];
            },
            notify: true
          },
          slides: {
            type: Array,
            value: function(){
              return [];
            },
            notify: true
          },
          attributes: {
            type: Object,
            value: function(){
              return {};
            },
            notify: true
          },
          wantedQty: {
            type: Number,
            notify: true,
            value: 1
          },
          price: {
            type: Number,
            notify: true,
            value: null
          }
           
         
        
        },
        observers: ['productChanged(product,product.*)','computePrice(product,attributes.*)','setSelectedAttributes(attributes,product)'],
        computePrice: function(product){
          // console.log('computePrice', profu)
          var attributes = this.get('attributes');
          var price = EDB.Checkout.getPrice( product.id, attributes);
          this.set('price', price||product.price );
        },
        productChanged: function(product){
          console.log('productChanged',product)
          
          var attributes = this.get('attributes');
          // this.set('slides', this.createProductSlides(product,this.get('materials')) );
          this.$.slideWrapper.innerHTML='';
          var slider = document.createElement('edb-slider');
          slider.slides = this.createProductSlides(product,this.get('materials'));
          this.$.slideWrapper.appendChild( slider );
          this.updateAttributesFromQueryString();
          // this.( attributes );
          
          // this.$.slider.set('slides', );
          
        },
        getVariationAttributeValue: function( v, attr, idx, prop ){
          return v.attributes[idx][prop];
        },
        computeStock: function( pid, attr, choice, attributes ){
          var attrs = {};
          attrs[attr.name]=choice.value;
          var stockQty = EDB.Checkout.getStock(pid, Object.assign( {}, attributes, attrs) );
          return stockQty;
        },
        computeStockIcon: function( pid, attr, choice, attributes ){
          
          var attrs = {};
          attrs[attr.name]=choice.value;
          var stockQty = EDB.Checkout.getStock(pid, Object.assign( {}, attributes, attrs) );
          // console.log('stockQty',stockQty)
          if(stockQty > 0){
            return 'edb:in-stock';
          }else{
            // TODOD COMPUTE RESTOCK
            return 'edb:restocking';
          }
          
          return null;
        },
        setSelectedAttributes: function(attributes){
          console.log('setSelectedAttributes',attributes);
          var product = this.get('product');
          if(!product) return;
          if(!product.attributes) return;
          Object.keys(attributes).forEach( function( name ){
            var selector = document.querySelector('iron-selector.'+name);
            
            var attribute =product.attributes.filter( function( a ){
              return a.name == name;
            });
            var values = attribute[0].options;
            if(selector){
                selector.selectIndex(values.indexOf( attributes[name] ));
            }
            // console.log('setSelectedAttributes', name, values.indexOf( attributes[name] ));
            // selector.selected = values.indexOf( attributes[name] );
          });
          // var attributes = this.get('attributes')||{};
          // // console.log('setSelectedAttribute',attribute);
          // var attrKeys = Object.keys(attributes);
          // if(!~attrKeys.indexOf(attribute.name)){
          //   if(attribute.name == 'slipcover'){
          //     return 0;
          //   }
          //   return null
          // }
          
          // var key = attrKeys[attrKeys.indexOf(attribute.name)];
          // var value =attributes[attribute.name];
          // var index = attribute.options.indexOf(value);
          
          // var selector = document.querySelector('iron-selector.'+attribute.name);
          // selector.selected = index;
          // console.log('setSelectedAttribute',key,index,selector,'iron-selector.'+attribute.name );
          
          // return index;
          
        },
        computeAttributes: function( product,materials ){
          EDB.Checkout.enhanceGroupAttributes(product);
          return (product.attributes || []).map( function( attr ){
            var foundMaterials = materials.filter( function( m ){
              return m.meta.edb_material_attribute == 'edb_'+attr.name;
            });
            attr.materials = foundMaterials.reduce( function(o,k){
              o[k.meta.edb_material_number] = k;
              return o;
            }, {});
            return attr;
          });
        },
        decrQty: function(){
          var q = this.get('wantedQty');
          if(q == 1) return;
          this.set('wantedQty', q-1);
        }, 
        incrQty:function(){
          var q = this.get('wantedQty');
          if(q > 100) return;
          this.set('wantedQty', q+1);
        },
        __computeAnatomy: function( a ){
          if(!a) return;
          var k = Object.keys(a);
          var img =a[k.shift()]; 
          return img ? img.full_url ? img.full_url : img.src ? img.src : null : null;
        },
        computeAttributeChoices: function( attr, variations ){
          // this.updateAttributesFromQueryString();
          var attributes = this.get('attributes');
          
          return attr.options.map( function( option ){
            var material = attr.materials[option];
            var selectedAttr = attr.name.replace(/^edb_/,'');
            if(material){

              return { icon: material.image.src, material: material, value: option, classnames: 'material-choice edb_' + attr.name };
            }else{
              return { label: option, value: option, classnames: 'text-choice edb_' + attr.name };
            }
          });
          
        },
        handleSelectedAttributeChanged: function( event ){
          this.set('attributes.'+event.model.attribute.name, event.model.attribute.options[event.detail.value]);
          this.notifyPath('attributes', this.get('attributes'));
        },
        handleAddToCart: function( event ){
          EDB.Checkout.addToCart( this.get('product').id, this.get('attributes'),this.get('wantedQty') );
        },
        createProductSlides: function( item ){
          if(!item) return [];
          if(!item.images) return [];
          // return [];
          return (item.images).map( function( i ){ return { image: i }; });
        },
        formatMoney: function( amount ){
          // console.log('formatMoney', this.get('product'))
          return EDB.format.money( amount );
        },
        updateAttributesFromQueryString: function(){
          
          var queryString = window.location.href.indexOf('?') > -1 ? window.location.href.slice(window.location.href.indexOf('?')+1) : '';
          
          var query = queryString ? QSJS().decode(queryString) : {};
          Object.keys(query).forEach( function( k){
            var name = k.replace(/^edb_/,'');
            var value = query[k];
            this.set('attributes.'+name, value);
          }, this)
          
          
        },
        attached: function(){
          this.updateAttributesFromQueryString();
        }
     
  
      });
  </script>
</dom-module>