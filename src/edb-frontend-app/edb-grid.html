<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="edb-grid">
  <template>
    <style>
      :host{
        display:block;
        width:100%;
        height:100%;
        
      }
      *{
        box-sizing:border-box;
      }
      #grid{
        display:block;
        
        @apply(--layout-vertical);
        
        margin:0;padding:0;
        
        /*float:left;*/
        width:100%;
      }
      
      #grid .cell,#grid .cell-inner{
        position:relative;
        width:100%;
        height:100%;
        
        float:left;
        @apply(--layout-vertical);
        cursor:pointer;
      }
      
      #grid .cell{
        margin-bottom:100px;
        transition:margin-bottom 0.33s ease-in;
      }
      #grid .cell.inview{
        margin-bottom:0;
      }
      
      #grid .cell-inner{
        /*background:blue;*/
        @apply(--layout-center-center);
        clear:both;
      }
      #grid .cell-inner > *{
        @apply(--layout-flex);
        clear:both;
        
      }
      :host[raised] #grid .cell-inner > *{
        @apply(--shadow-elevation-2dp);
      }
      #grid .cell.square{
        height:0;
        
      }
      #grid .cell.square .cell-inner{
          position:absolute;
          width:100%;
          height:100%;
          @apply(--layout-vertical);
          @apply(--layout-center-center);
          top:0;left:0;bottom:0;right:0;
          margin:0;padding:0;box-sizing:border-box;
      }
      
      /*#grid .cell.hero,*/
      /*#grid .cell.square.hero,*/
      /*#grid .cell.full.hero,*/
      /*#grid.thirds .cell.hero,*/
      /*#grid.thirds .cell.square.hero,*/
      /*#grid.thirds .cell.full.hero{*/
      /*  margin:0px;*/
      /*  min-width:100%!important;*/
      /*  height:calc(100vh - 140px);*/
        
      /*}*/
      @media all and (min-width:768px){
        #grid{
          @apply(--layout-horizontal);
          /*@apply(--layout-justified);*/
          @apply(--layout-wrap);
          padding:30px;
        }
        #grid .cell{
          /*color:Red;*/
          width:50%;
          max-width:50%;
          
        }
        #grid .cell.square{
          width:50%;
          max-width:50%;
          height:0;
          padding-top:60%;
        }
        #grid .cell .cell-inner{
          padding:10px;
        }
        #grid .cell.square .cell-inner{
            position:absolute;
            width:100%;
            height:100%;
            @apply(--layout-vertical);
            @apply(--layout-center-center);
            top:0;left:0;bottom:0;right:0;
            margin:0;box-sizing:border-box;
            padding:10px;
        }
        #grid .cell.full .cell-inner{
          padding:10px;
          
        }        
        #grid .cell.full{
          width:100%;
          min-width:100%;
          height:100%;
        }
        #grid .cell.full.square{
          width:100%;
          max-width:100%;
          height:0;
          padding-top:100%;
          
        }
        #grid .cell.full.square .cell-inner{
            position:absolute;
            width:100%;
            height:100%;
            @apply(--layout-vertical);
            @apply(--layout-center-center);
            top:0;left:0;bottom:0;right:0;
            margin:0;padding:10px;box-sizing:border-box;
        }
        
        
        
        /*#grid .cell.square .cell-inner{*/
        /*    position:absolute;*/
        /*    width:100%;*/
        /*    height:100%;*/
        /*    @apply(--layout-vertical);*/
        /*    @apply(--layout-center-center);*/
        /*    top:0;left:0;bottom:0;right:0;*/
        /*    margin:0;padding:0;box-sizing:border-box;*/
        /*}*/
      }
      @media all and (min-width:900px){
        
        #grid.thirds .cell{
          /*color:Red;*/
          width:calc(100% / 3);
          max-width:calc(100% / 3);
        }
        #grid.thirds .cell.square{
          width:calc(100% / 3);
          max-width:calc(100% / 3);
          height:0;
          padding-top:calc(100% / 3);
        }
        #grid.thirds .cell.full.square{
          padding-top:calc(100% );
        }
      }
      
      
      #data{
        display:none;
      }
      
    </style>
    
    <div id="grid"></div>
    <div id="data">
      <content id="contentNode"></content>
    </div>
    
    <granite-spinner id="spinner" size="50" color="#000" hover active="{{loading}}"></granite-spinner>
  </template>
  <script>
     function getToken(){
       return Number(Date.now() + '' + Math.floor(Math.random()*Date.now())).toString(24);
     }
      Polymer({
  
        is: 'edb-grid',
  
        properties: {
          layout: {
            type: String,
            value: null,
            notify: true
          },
          loading: {
            type: Boolean,
            notify: true,
            value: false
          },
          nodeMap: {
            type: Object,
            value: function(){ return {}; },
            notify: true
          },
          allowThirds: {
            type: Boolean,
            value: false,
            observer: '_setThirds'
          }
          
        
        },
        _setThirds: function(t){
          if( t ){
            this.$.grid.classList.add('thirds');
          }else{
            this.$.grid.classList.remove('thirds');
          }
        },
        processNewNode: function( node ){
          if(!node.dataset) return;
          
          if(node.nodeName =='TEMPLATE'){
            return;  
          }
          

          // if(!node.dataset.gridId){
          //   node.dataset.gridId = getToken();
          // }
          // this.set('nodeMap.'+node.dataset.gridId, {} )
          // this.setNodeWidth( node );
          // console.log(this.get('nodeMap'))
          var isSquare = node.classList.contains('square');
          var isFull = node.classList.contains('full');
          var isHero = node.classList.contains('hero');
          var wrap = document.createElement('div');
          var inner = document.createElement('div');
          wrap.setAttribute('class', 'cell');
          inner.setAttribute('class', 'cell-inner');
          inner.appendChild( node )
          wrap.appendChild( inner );
          if(isSquare){
            wrap.classList.add('square')
          }
          if(isFull){
            wrap.classList.add('full')
          }
          if(isHero){
            wrap.classList.add('hero')
          }
          node.removeWrapper = function(){
            wrap.parentNode.removeChild( wrap );
          };
          
          Polymer.dom(this.$.grid).appendChild(wrap);
        },
        processRemovedNode: function( node, index ){
          if(!node.dataset) return;
          if(node.removeWrapper ){
            node.removeWrapper();
          }
          
          // this.set('nodeMap.'+node.dataset.gridId, null );
          // node.parentNode
          // console.log(this.$.grid.querySelector( '.cell:nth-of-type('+index+')' )); 
        },
        _scrollCheck: function(){
          console.log('SCROLL',this.querySelectorAll('.cell'));
        },
        ready: function(){
          
          Polymer.dom(this.$.contentNode).observeNodes(function(info) {
            info.addedNodes.forEach( this.processNewNode, this );
            info.removedNodes.forEach( this.processRemovedNode, this );
          }.bind(this));
          // Polymer.dom(this.$.data).observeNodes(function(info) {
          //   info.addedNodes.forEach( this.processNewNode, this );
          //   info.removedNodes.forEach( this.processRemovedNode, this );
          // }.bind(this));
          
          window.addEventListener('scroll',function(){
            this.debounce('scrollPadding', this._scrollCheck.bind(this), 100);
          }.bind(this));
          
          
        }
        // __proxyPrev: function(){
        //   this.$.swiper._swiper.slidePrev();
        // },
        // __proxyNext: function(){
        //   this.$.swiper._swiper.slideNext();
        // },
        // hasNavigation: function( l ){
        //   return ~['medium','large','xlarge'].indexOf(l)
        // },
        // hasPagination: function( l ){
        //   return ~['medium','large','xlarge'].indexOf(l)
        // },
        // ready: function(){
        //   this.$.swiper.options.autoplayDisableOnInteraction=false;
        //   this.$.swiper.options.autoplay=5000;
        //   this.$.swiper.options.onSlideChangeEnd = function( e ){
        //     this.set('slideCount', this.slides.length );
        //     this.set('slideIndex',  e.realIndex + 1 );
        //   }.bind(this)
          
          
        // }
        
     
  
      });
  </script>
</dom-module>