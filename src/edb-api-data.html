<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<dom-module id="edb-api-data">
  <template>
    <app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location>
    <app-route route="[[route]]" data="{{routeData}}"></app-location>
  </template>
  <script>
    /**
     * `edb-api-endpoint`
     * edb API endpoint
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    (function(){
      if(window.EdbApiData) return;
      //
      // Define your database
      // //
      var db = new Dexie("edb_dev_api");
      var schemas = {
        // jwtAuth: {
        //   store:  'token',
        //   url: '/wp-json/jwt-auth/v1/token',
        //   method: 'post',
        //   type: 'documents'
        // },
        
        currentUser: {
          
          url: '/wp-json/wp/v2/users/me',
          method: 'get',
          store: 'document'
        },
        pages: {
          
          url:'/wp-json/wp/v2/pages',
          method: 'get',
          store: 'collection'
        },
        materials: {
          
          url:'/wp-json/wp/v2/materials',
          method: 'get',
          store: 'collection'
        },
        slides:{
          
          url:'/wp-json/wp/v2/slides',
          method: 'get',
          store: 'collection'
        },
        features: {
          
          url:'/wp-json/wp/v2/features',
          method: 'get',
          store: 'collection'
        },
        inspirations: {
          url:'/wp-json/wp/v2/inspirations',
          method: 'get',
          store: 'collection'
        },
        lookbooks: {
          url:'/wp-json/wp/v2/lookbooks',
          method: 'get',
          store: 'collection'
        },
        products: {
          url:'/wp-json/wc/v2/products',
          method: 'get',
          store: 'collection',
          params: {
            per_page: 100
          }
        },
        variations: {
          method: 'get',
          store: 'collection',
          childOf: 'products',
          url: function(parent){
            return '/wp-json/wc/v2/products/'+parent.id+'/variations';
          }
          
        }
      };
      
      var resources = Object.keys(schemas).reduce( ( res, key )=>{
        var schema = schemas[key];
        var objectType = /collection/.test(schema.store) ? Array: Object;
        var defaultValue = new (objectType)();
        var upperCase = key.slice(0,1).toUpperCase() + key.slice(1);
        var childData = {};
        var storeName = schemas[key].store;
        var isDocument = /document/.test(schema.store);
        var isCollection = /collection/.test(schema.store);
        var isChild =  !!schema.childOf;
        var childOf = schema.childOf;
        var setterName = '_set' + upperCase;
        var resourceName = key;
        if( isChild ){
          var parentResource = schema.childOf.slice(0,-1);
          childData.parentIdProperty = 'current'+(parentResource.slice(0,1).toUpperCase()+parentResource.slice(1))+'Id';
          // childData.childDataProperty = 'current' + (parentResource.slice(0,1).toUpperCase() + parentResource.slice(1)) + (key.slice(0,1).toUpperCase()+key.slice(1));
          var dualName;
          if(isCollection){
             dualName = childOf.slice(0,-1) + '_' + key;  
          }else{
             dualName = childOf.slice(0,-1) + '_' + key.slice(0,-1);  
          }
          resourceName = dualName.split('_').map( (p,i)=>{ return i === 0 ? p : p.slice(0,1).toUpperCase() + p.slice(1); }).join('');
          var compositeName = resourceName.slice(0,1).toUpperCase() + resourceName.slice(1);
          setterName = '_set'+compositeName;
        }
        res[key]  = Object.assign({},schema,{
          name: resourceName,
          setterName: setterName,
          isChild: isChild,
          isCollection: isCollection,
          isDocument: isDocument,
          objectType:objectType,
          defaultValue:defaultValue,
          getStore: function(){
            console.log(storeName)
            return db[storeName].where('resource').equals( resourceName ).first().then( ( stored )=>{
              if(stored) return stored.data;
              return defaultValue;
            });
          },
          putStore: function( id, data ){
            data = data || defaultValue;
            if(isChild){
              if(!id) return Promise.reject('Missing ID for child.');
              // console.log('putting', data )
              return db[storeName].put( { resource: resourceName, timestamp: Date.now(), data: data } ).then( function(){
                if(isCollection){
                  var ids = data.map( (item)=>{ return item.id; });
                  return db.collection_map.put( { parent_resource: childOf, child_resource: resourceName, parent_id: id, child_ids: ids  } );
                }else{
                  return db.document_map.put( { parent_resource: childOf, child_resource: resourceName, parent_id: id, child_id: data.id  } );
                }  
              });
            }else{
              // console.log('putting', data )
              return db[storeName].put({
                resource: resourceName,
                timestamp: Date.now(),
                data: data
              });
            }
          },
          clearStore: function( id ){
            if(isChild){
              if(!id) return Promise.reject('Missing ID for child.');
              return db[storeName].where('resource').equals(key).delete().then( ()=>{
                if(isCollection){
                  return db.collection_map.where('parent_resource').equals(childOf).and('child_resource').equals(resourceName).and('parent_id').equals(id).delete();
                }else{
                  return db.document_map.where('parent_resource').equals(childOf).and('child_resource').equals(resourceName).and('parent_id').equals(id).delete();
                }  
              });
            }else{
              return db[storeName].where('resource').equals(key).delete();
            }
          }
          // 
        },childData);
        return res;
      }, {});
      // var stores = Object.keys(resources).reduce( function( stores, key ){
      //   stores[key] = resources[key].store;
      //   return stores;
      // }, {} );
      
      var stores = {
        collection: 'resource,timestamp,*data.id',
        document: 'resource,timestamp,data.id',
        collection_map: 'parent_resource,child_resource,parent_id,*child_ids',
        document_map: 'parent_resource,child_resource,parent_id,child_id',
        // child_collections: 'resource,parent_resource,parent_id,*data.id',
        // child_documents: 'resource,parent_resource,parent_id,data.id',
        jwtAuth: 'token'
      };
      

      
      db.version(2).stores( stores );
      
     

      
      
      class EdbApiData extends Polymer.Element {
        static get is() { return 'edb-api-data'; }
        static get properties(){
          var resourcesProperties = Object.keys( resources ).reduce( (props, key )=>{
              var resource = resources[key];
              var value = null;
              props[resource.name] = {
                type: resource.objectType,
                notify: true,
                readOnly: true,
                value: ()=>{
                  return resource.defaultValue;
                }
              }
              if(resource.isChild){
                props[resource.parentIdProperty] = {
                  type: Number,
                  notify: true,
                  readOnly: true,
                  value: ()=>{
                    return resource.defaultValue;
                  }
                }
               
              }
            return props;
          }, {} );
          return Object.assign({
            dataSource: {
              type: Object,
              notify: true,
              value: ()=>{
                return {};
              }
            },
            headers: {
              type: Object,
              computed: '_computeHeaders(defaultHeaders,authHeaders)'
            },
            defaultHeaders: {
              type: Object,
              value: function(){
                return {
                  "X-Requested-With": "XMLHttpRequest",
                  "cache-control": "max-stale"
                };
              }
            },
            authHeaders: {
              type: Object,
              value: function(){
                return {};
              }
            },
            apiRoot: {
              type: String,
              value: 'https://installatex.ca'
            },
            rootPath: {
              type: String,
            },
            route: {
              type: Object
            },
            routeData:{
              type: Object
            }
          },resourcesProperties);
        }
        
        static get observers(){
          var parentIdObservers = Object.keys(resources).filter( ( k )=>{ 
            return resources[k].parentIdProperty 
          }).map((k)=>{ 
            return [ '_onParentIdChanged("', resources[k].name, '",', resources[k].parentIdProperty,')'].join('');
          });
          return [].concat(parentIdObservers);
          // return ['_onJwtAuthChanged(jwtAuth)','_prepareForRoute(route,routeData)']
        }
        _onParentIdChanged(a,b){
          console.log('_onParentIdChanged',a,b)
        }
        
        _populateStore( key, id , data){
          var resource = resources[key];
          if(!resource.isChild){
            console.log('updated value from ajax at key:' + resource.name, 'value: ', data );
            ;
            return resource.putStore( id,data).then(()=>{
              console.log('stored value from ajax at key:' + resource.name, 'value: ', data );
            });
          }else if(id){
            return resource.putStore( id,data ).then(()=>{
              console.log('stored child value from ajax at key:' + resource.name, 'value: ', data );
            });
            // console.log('IGNORED',key, this[key])
          }
          return Promise.resolve();   
        }
        
        _populateFromStore( key ){
          var resource = resources[key];
          return resource.getStore().then( ( value )=>{
            this.dataSource[resource.name] = 'indexeddb';
            if(this.dataSource[resource.name] !== 'remote'){
              this[resource.setterName].call( this, value );  
              console.log('set value from store at key:' + resource.name, 'value: ', value);
            }
          })
          
        }
        
        _syncFromRemote( key, id  ){
          var resource = resources[key];
          
          var xhr = document.createElement('iron-request'); 
          if(!resource.isChild){
            var method = resource.method;
            var request = {
              url: this.apiRoot  + resource.url,
              method: resource.method,
              body:  this[key+'RequestBody'],
              params: resource.params,
              contentType:'application/json',
              handleAs: 'json',
              headers: this.headers  
            }
            
            
            var onComplete = ()=>{
              var response = xhr.response;
              var newValue = response;
              
              this.dataSource[key] = 'remote';
              console.log('calling',resource.setterName, newValue )
              this[resource.setterName].call( this, newValue );
              Polymer.Async.idlePeriod.run( ()=>{
                this._populateStore( key, null, newValue );  
              });
              
            }
            var onError = (error)=>{
              console.log('onError', error )
            }
            
            Polymer.Async.microTask.run( ()=>{
              xhr.send( request ).then( onComplete ).catch( onError ) 
            } );
          }else if( !id ){
            var parentResource = resource.childOf.slice(0,-1);
            // var idPropName = 'current'+(parentResource.slice(0,1).toUpperCase() + parentResource.slice(1))+'Id';
            if(!this[resource.parentIdProperty]){
              return Promise.reject('No id!' +  key);
            }else{
              return  this._syncFromRemote( key, this[resource.parentIdProperty] );
            }
          }else{
            var parent  = { id: id };
            var method = resource.method;
            var request = {
              url: this.apiRoot  + resource.url( parent ),
              method: resource.method,
              params: resource.params,
              contentType:'application/json',
              handleAs: 'json',
              headers: this.headers  
            }
            
            
            var onComplete = ()=>{
              var response = xhr.response;
              var newValue = response;
              console.log("GOT",newValue);
             
              // var setter = '_set' + childPropertyName.slice(0,1).toUpperCase() + childPropertyName.slice(1);
              this.dataSource[key] = 'remote';
              // console.log('calling',resource.setterName, newValue )
              this[resource.setterName].call( this, newValue );
              
              // this.set(resource.name,newValue);
              // if(resource.isDocument){
              //   this[resource.setterName].call( this, newValue );
              // }else{
              //   var newIds = response.map((item)=>{ return item.id });
              //   if(this[resource.name].length > 0){
              //     var others = this[resource.name].filter((item)=>{
              //         return !~newIds.indexOf(item.id);
              //     });
              //     console.log('SETTING', resource.name, others.concat( newValue ) );
              //     this.set(resource.name, others.concat( newValue ));
              //   }else{
              //     console.log('SETTING', resource.name, newValue);
              //     this.set(resource.name,newValue);
              //   }
              // }
              
              this[resource.setterName].call( this, newValue );
              Polymer.Async.idlePeriod.run( ()=>{
                this._populateStore( resource.name , id, newValue);  
              });
            }
            var onError = (error)=>{
              console.log('onError', error )
            }
            
            Polymer.Async.microTask.run( ()=>{
              xhr.send( request ).then( onComplete ).catch( onError ) 
            } );
          }
          return Promise.resolve();
        }
        
        
        constructor(){
          super();
          console.log('// Opening database...');
          this.currentProductId = 463;
          console.log(EdbApiData.properties)
          db.open().then( (db)=> {
            console.log('// Database opened successfully');
            return Object.keys(resources).reduce( ( previous, key )=>{
              return previous.then( ()=>{
                return Promise.all([
                  this._syncFromRemote( key ) ,
                  this._populateFromStore( key )
                  
                ]);
              });
            }, Promise.resolve() );
            
          }).catch ( (err)=> {
            console.log('// Error occurred', err );
          });
          
        }
        
        _computeHeaders(defaultHeaders,authHeaders){
          return Object.assign({},defaultHeaders,authHeaders);
        }
        
        _onJwtAuthChanged(jwtAuth){
          if(!this.ajax || (this.ajax && !this.ajax.jwtAuth)){
            return;
          }
          if(this._isNotDefined(jwtAuth) || jwtAuth === null){
            this.set('authHeaders', {});
          }else{
            this.set('authHeaders', { 'Authorization': 'Bearer ' + jwtAuth.token });
            Polymer.Async.microTask.run( this.ajax.currentUser.generateRequest.bind( this.ajax.currentUser ) );
          }
        }
       
        /**
         * Checks if arguments are not undefined or empty strings
         *
         * @return {Boolean}
         */
        _isNotDefined() {
          let i;
          for (i = 0; i < arguments.length; i++) {
            if (typeof arguments[i] === 'undefined' || arguments[i] === '') return true;
          }
        }
        
       
        
      } 
      
      
      window.EdbApiData = EdbApiData;
      window.customElements.define(EdbApiData.is, EdbApiData);
      
      
    })();
  </script>
</dom-module>