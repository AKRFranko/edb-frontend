<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="edb-api-catalog">
  <template></template>
  <script>
    /**
     * `edb-api-endpoint`
     * edb API endpoint
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    (function(){
    
     

      
      
      class EdbApiCatalog extends Polymer.Element {
        static get is() { return 'edb-api-catalog'; }
        static get properties(){
          return {
            products: Array,
            variation: Object,
            currentProduct: Object,
            currentVariations: Array,
            currentCategory: String,
            buckets: Object,
            materials: Array,
            userSelections: {
              type: Object,
              notify: true,
              value: function(){
                return {};
              }
            },
            items: {
              type: Array,
              notify: true,
              readOnly: true,
              value: function(){
                return [];
              }
            },
            currentItem: {
              type: Object,
              notify: true,
              readOnly: true,
              value: function(){
                return {};
              }
            },
            categories: {
              type: Array,
              value: function(){
                return [];
              },
              notify: true
            }
            
          }
        }
        
        static get observers(){
          return [
            '_onProductsChanged(products)',
            '_onCurrentCategoryChanged(currentCategory,products)',
            '_onCurrentProductChanged(currentProduct,currentVariations)'
          ];
        }
        
        
        constructor(){
          super();
          this.__catMap = {};
        }
        _onProductsChanged(products){
          
          if(products && products.length){
            // console.log('onProducts',products)
            products.forEach((product)=>{
              product.categories.forEach( ( cat )=>{
                if(!this.__catMap[cat.slug]){
                  // console.log('categories.'+cat.slug)
                  this.__catMap[cat.slug] = cat;
                  this.push('categories', cat);
                }
              });
            });
            this.__createUnits(products);
            // this.notifyPath('categories');
          }
          // console.log(this.categories)
          
        }
        
        __productMatchesCategory( product, category ){
          return product.categories.some( ( pCat )=>{
            return pCat.slug == category;
          });
        }
        
        __getProductType(product){
          var isBucket     = product.meta_box.edb_is_bucket=='1';
          var hasBasePrice = ( product.meta_box.edb_base_price || product.meta_box.edb_base_price == '');
          var hasGroupIds  = !!product.meta_box.edb_group_ids;
          if( isBucket ) return 'bucket';
          if( hasBasePrice) return 'base';
          if(hasGroupIds) return 'composite';
          return 'normal';
          
        }
        __productIsBucket(product){
          return this.__getProductType(product) == 'bucket';
        }
        
        __productIsNormalUnit(product){
          return this.__getProductType(product) == 'normal';
        }
        
        __productIsBaseUnit(product){
          return this.__getProductType(product) == 'base';
        }
        
        __productIsCompositeUnit(product){
          return this.__getProductType(product) == 'composite';
        }
        
        
        
        __mapToObject( keyProp, array, object ){
          return array.reduce( ( obj, item )=>{
            obj[Polymer.Path.get(item,keyProp)] = item;
            return obj;
          }, object||{});
        }
        
        
        __createUnits(matchingProducts){
          var normalUnits = matchingProducts.filter( this.__productIsNormalUnit.bind( this ) );
          var baseUnits = matchingProducts.filter( this.__productIsBaseUnit.bind( this ) );
          var compositeUnits = matchingProducts.filter( this.__productIsCompositeUnit.bind( this ) );
          var buckets = this.products.filter( this.__productIsBucket.bind(this) );
          this.normalUnits = this.__mapToObject('id', normalUnits);
          this.baseUnits = this.__mapToObject('id', baseUnits);
          this.compositeUnits = this.__mapToObject('id', compositeUnits);
          this.buckets = this.__mapToObject('meta_box.edb_bucket_slug', buckets );
        }
        
        __createAttributeProxy( type, unit, attribute ){
          var real = this;
          var proxy = {
            name: attribute.name,
            isVariationChoice: attribute.variation,
            isBucketChoice: !!this.buckets[attribute.name],
            defaultSelection: attribute.options[0],
            get choices(){
              return attribute.options.map( ( option, optionIndex )=>{
                if(/slipcover/.test(attribute.name)){
                  if(!real.materials) return null;
                  var found = real.materials.findIndex( ( m )=>{
                    return m.meta_box.edb_material_number == option;
                  });
                  // console.log('material found', option, found);
                  return { name: option, get material(){
                    
                    return found > -1 ? real.materials[found] : null
                  } };  
                }else if(/leg/.test(attribute.name)){
                  return { name: option, get leg(){
                    var bucket = real.buckets.edb_leg;
                    var variation = bucket.variation_data[optionIndex];
                    return variation;
                  }};  
                }
                
                return { name: option };
                
              })
            },
            get selected(){
              var unitSelections = real.userSelections[unit.id] ||{};
              var attributeSelections = unitSelections[attribute.name]||null;
              // console.log('get',unit.id+'.attributes.'+attribute.name )
              return attributeSelections;
            },
            set selected( value ){
              if(!real.userSelections[unit.id]){
                real.userSelections[unit.id] = {};
              }
              real.userSelections[unit.id][attribute.name] = value;
              console.log('set',unit.id+'.attributes.'+attribute.name, value )
              real.notifyPath(unit.id+'.attributes.'+attribute.name, value );
              return true;
            }
           
          };
          
          return proxy;
        }
        
        __createUnitProxy( type, unit, groupIds ){
          
          var real = this;
          var properties = {
            id: {
              value: unit.id,
            },
            type: {
              value: type,
            },
            gids: {
              value: groupIds||[]
            },
            name: {
              value: unit.name,
            },
            description: {
              value: unit.description,
            },
            whyWeLove: {
              get: function(){
                var title = unit.meta_box.edb_why_we_love_title;
                var content = unit.meta_box.edb_why_we_love_content;
                if(title && content){
                  return {title: title, content: content };
                }else{
                  return {title:null,content:null};
                }
              }
            },
            image: {
              get: function(){
                return unit.images[0];
              }
            },
            images: {
              get: function(){
                return unit.images.slice(1);
              }
            },
            wireframe: {
              get: function(){
                return unit.meta_box.edb_wireframe;
              }
            },
            anatomy: {
              get: function(){
                return unit.meta_box.edb_anatomy_en || unit.meta_box.edb_anatomy_fr;
              }
            },
            
            wanted: {
              get: function(){
                var unitSelections = real.userSelections[unit.id] ||{};
                // console.log('get',unit.id+'.wanted' )
                return unitSelections.wanted;
              },
              set: function(qty){
                if(!real.userSelections[unit.id]){
                  real.userSelections[unit.id] = {};
                }
                real.userSelections[unit.id].wanted = qty||0;
                // console.log('set',unit.id+'.wanted',qty);
                return qty||0;
              }
            },
            price: {
              get: function(){
                  return parseFloat(unit.price);
              }
            },
            minPrice: {
              get: function(){
                return parseFloat(unit.price) + (unit.meta_box._min_variation_price ? parseFloat(unit.meta_box._min_variation_price) : 0);
              }
            },
            maxPrice: {
              get: function(){
                return parseFloat(unit.price) + (unit.meta_box._max_variation_price ? parseFloat(unit.meta_box._max_variation_price) : 0);
              }
            },
            variations: {
              get: function(){
                return unit.variations.map( (v)=>{ return { id: v } } );
              }
            },
            options: {
              get: function(){
                return unit.attributes.reduce( ( object, attribute )=>{
                  object[attribute.name]  = real.__createAttributeProxy( type, unit, attribute );
                  return object;
                }, {} );    
              }
            }
          };

          
          switch(type){
            case 'base':
              Object.assign( properties, {
                price: {
                  get: function(){
                    return parseFloat(unit.meta_box.edb_base_price);  
                  }
                },
                minPrice: {
                  get: function(){
                    return this.price + parseFloat(unit.meta_box._min_variation_price); 
                  }
                },
                maxPrice: {
                  get: function(){
                    return this.price + parseFloat(unit.meta_box._max_variation_price);
                  }
                }
              });
              
            break;
            case 'composite':
              
              Object.assign(properties, {
                parents: {
                  get: function(){
                    return this.gids.map( (pid)=>{
                      if( real.baseUnits[pid]){
                        return real.baseUnits[pid].proxy;
                      }
                      if( real.normalUnits[pid]){
                        return real.normalUnits[pid].proxy;
                      }
                    });
                  } 
                },
                price: {
                  get: function(){
                    return this.parents.reduce( function(a,b){return (1*a) + b.price; }, unit.price||0);
                  }
                },
                minPrice: {
                  get: function(){
                    
                    return this.parents.reduce( function(a,b){return (1*a) + b.minPrice; }, unit.meta_box._min_variation_price||0);
                  }
                },
                maxPrice: {
                  get: function(){
                    return this.parents.reduce( function(a,b){return (1*a) + b.maxPrice; }, unit.meta_box._max_variation_price||0);
                  }
                },
                wanted: {
                  get: function(){
                    return this.parents.reduce( function(a,b){ return Math.max(a,b) },0);
                  },
                  set: function(qty){
                   this.parents.forEach( function( p ){
                     return (p.wanted = qty);
                   }); 
                  }
                },
                options: {
                  get: function(){
                    return this.parents.reduce( function(a,b){
                      return Object.keys(b.options).reduce( function( aa, k ){
                        aa[k] = b.options[k];
                        return aa;
                      }, a );
                    }, {} );
                  }
                }
                
              });
            break;
          }
          // properties = Object.keys(properties).reduce( function(p,k){
          //   p[k].configurable = true;
          //   return p;
          // }, properties)
          if(!unit.proxy){
            unit.proxy = {};
            Object.defineProperties(unit.proxy, properties );
          }else{
            console.warn('old proxy override?');
            // Object.defineProperties(unit.proxy, properties );
          }
          return unit.proxy;
        }
        
        _createArrayForCategory( category ){
            var catalog = [];
            Object.keys(this.normalUnits).forEach( ( key )=>{
              catalog.push( this.__createUnitProxy( 'normal', this.normalUnits[key] ) );
            });
            Object.keys(this.baseUnits).forEach( ( key )=>{
              catalog.push( this.__createUnitProxy( 'base', this.baseUnits[key] ) );
            });
            Polymer.Async.idlePeriod.run( ()=>{
              Object.keys(this.compositeUnits).forEach( ( key )=>{
                var unit = this.compositeUnits[key];
                catalog.push( this.__createUnitProxy( 'composite', unit, unit.meta_box.edb_group_ids.split(',')) );
              });
              this._setItems(catalog);  
              console.log('items',this.baseUnits);
            })
            
            
            
          // });
        }
        
        _createObjectForProduct( product,variations ){
          // console.log('_createObjectForProduct')
          var object = {};
          var type = this.__getProductType(product);
          var proxy,unit;
          if(this.normalUnits[product.id]){
            unit = this.normalUnits[product.id];
          }else if(this.baseUnits[product.id]){
            unit = this.baseUnits[product.id];
          }else if(this.compositeUnits[product.id]){
             unit = this.compositeUnits[product.id];
           }
           var gids = unit.meta_box.edb_group_ids ? unit.meta_box.edb_group_ids.split(','): null;
           proxy = this.__createUnitProxy(type, unit, gids );
           this._setCurrentItem( proxy );
          // console.log('currentItem',proxy);
        }
        
        _onCurrentCategoryChanged(category,products){
          
          if(category && products && products.length && !this.currentProduct ){
            console.log('calling _onCurrentCategoryChanged('+category+')');
            this._createArrayForCategory( category );
          }
        }
        
        _onCurrentProductChanged(product,variations){
          if(product){
            console.log('calling _onCurrentProductChanged('+product.id+')');
            if(!variations && !product.variations){
              this._createObjectForProduct( product, [] );
            }else{
              this._createObjectForProduct( product,variations );  
            }
          }
        }
        
       
        
      } 
      
      
    window.EdbApiCatalog = EdbApiCatalog;
          window.customElements.define(EdbApiCatalog.is, EdbApiCatalog);
          
          
        })();
  </script>
</dom-module>