<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<dom-module id="edb-api-request">
  <template></template>
  <script>
    /**
     * `edb-api-endpoint`
     * edb API endpoint
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    (function(){
      if(!window.EDBBrowserCache){
      //
      // Define your database
      // //
      var db = new Dexie("edb_api_request_cache");
      
      var stores = {
        requests: 'url,timestamp,response'
      };
      
      db.version(1).stores( stores );
      
      window.onunhandledrejection = function (event) {
        event.preventDefault();
        let reason = event.reason;
        console.warn('Unhandled promise rejection:', (reason && (reason.stack || reason)));
      };
      
      window.EDBBrowserCache = {
        isConnected: false,
        _waitForConnection: function( resolutionHandler, context ){
          return new Promise( function(resolve, reject ){
            if(window.EDBBrowserCache.isConnected === true){
              resolutionHandler.call( context||null, resolve, reject );
            }else{
              db.on("ready", function () {
                 window.EDBBrowserCache.isConnected = true;
                 resolutionHandler.call( context||null, resolve, reject );
              });  
            }
          });
        },
       
        putRequest: function( request ){
          return window.EDBBrowserCache._waitForConnection( function( resolve, reject ){ 
            var url = request.requestUrl;
            var timestamp = Date.now();
            var response = request.lastResponse;
            var query;
            if(!url) return Promise.reject('no URL');
            if(response === null){
              return db.requests.where({url:url}).delete()
            }else{
              db.requests.put({url:url,timestamp:timestamp, response: response }).then(resolve,reject);  
            }
            
          });
        },
        
        getRequest: function( request ){
          return window.EDBBrowserCache._waitForConnection( function(resolve,reject){
            var url = request.requestUrl;
            if(!url) return Promise.reject('no URL');
            return db.requests.where({url:url}).first().then(resolve,reject);
          });
          
        },
        flushall: function(){
          return db.requests.clear();
        }
      }
      
      db.open().then( (db)=> {
        console.log('// Database opened successfully');
      }).catch ( (error)=> {
        console.log('// Error occurred', error );
      });
      
      

      }
      
     

      
      
      class EdbApiRequest extends customElements.get('iron-ajax') {
        static get is() { return 'edb-api-request'; }
        static get properties(){
          return {
            lastSource: {
              type: String,
              notify: true,
              value: null
            }   
          }
        }
        
        static get observers(){
          return ['_updateCache(lastResponse)']
        }
        
        _updateCache(){
          this.lastSource = 'remote';
          window.EDBBrowserCache.putRequest( this ).then( ()=>{
            // console.log(this.url, 'stored request!');
          })
        }
        
        _updateFromCache( data ){
          if(this.lastSource === 'remote'){
            return true;
          }
          if(!data){
            // console.log(this.url,'setting NULL from cache')
            this._setLastResponse(null);  
          }else{
            // console.log(this.url,'setting DATA from cache', Array.isArray(data.response) ? data.response.length + ' item(s)' : typeof data.response );
            this._setLastResponse(data.response);  
          }
        }
        
        _beforeSend( event ){
          window.EDBBrowserCache.getRequest( this ).then( this._updateFromCache.bind(this) );
        }
        
        constructor(){
          super();
          this.addEventListener('iron-ajax-presend', this._beforeSend.bind(this) );
          // console.log(this)
        }
       
        
      } 
      
      
      window.EdbApiRequest = EdbApiRequest;
      window.customElements.define(EdbApiRequest.is, EdbApiRequest);
      
      
    })();
  </script>
</dom-module>